function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(e){var t=_isNativeReflectConstruct();return function(){var i,r=_getPrototypeOf(e);if(t){var s=_getPrototypeOf(this).constructor;i=Reflect.construct(r,arguments,s)}else i=r.apply(this,arguments);return _possibleConstructorReturn(this,i)}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Curtains={})}(this,(function(e){"use strict";function t(){var e=Array.prototype.slice.call(arguments);console.warn.apply(console,e)}function i(){var e=Array.prototype.slice.call(arguments);console.error.apply(console,e)}function r(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16).toUpperCase()}))}function s(e){return 0==(e&e-1)}var a=function(){function e(t){_classCallCheck(this,e),this.type="Scene",t&&"Renderer"===t.type?t.gl||i(this.type+": Renderer WebGL context is undefined",t):i(this.type+": Renderer not passed as first argument",t),this.renderer=t,this.gl=t.gl,this.initStacks()}return _createClass(e,[{key:"initStacks",value:function(){this.stacks={opaque:{length:0,programs:[],order:[]},transparent:{length:0,programs:[],order:[]},renderPasses:[],scenePasses:[]}}},{key:"resetPlaneStacks",value:function(){this.stacks.opaque={length:0,programs:[],order:[]},this.stacks.transparent={length:0,programs:[],order:[]};for(var e=0;e<this.renderer.planes.length;e++)this.addPlane(this.renderer.planes[e])}},{key:"resetShaderPassStacks",value:function(){this.stacks.scenePasses=[],this.stacks.renderPasses=[];for(var e=0;e<this.renderer.shaderPasses.length;e++)this.renderer.shaderPasses[e].index=e,this.renderer.shaderPasses[e]._isScenePass?this.stacks.scenePasses.push(this.renderer.shaderPasses[e].index):this.stacks.renderPasses.push(this.renderer.shaderPasses[e].index);0===this.stacks.scenePasses.length&&(this.renderer.state.scenePassIndex=null)}},{key:"initProgramStack",value:function(e){this.stacks.opaque.programs["program-"+e]=[],this.stacks.transparent.programs["program-"+e]=[]}},{key:"addPlane",value:function(e){this.stacks.opaque.programs["program-"+e._program.id]||this.initProgramStack(e._program.id);var t=e._transparent?"transparent":"opaque",i=this.stacks[t];"transparent"===t?(i.programs["program-"+e._program.id].unshift(e.index),i.order.includes(e._program.id)||i.order.unshift(e._program.id)):(i.programs["program-"+e._program.id].push(e.index),i.order.includes(e._program.id)||i.order.push(e._program.id)),i.length++}},{key:"removePlane",value:function(e){this.resetPlaneStacks()}},{key:"movePlaneToFront",value:function(e){var t=e._transparent?"transparent":"opaque",i=this.stacks[t].programs["program-"+e._program.id];i=i.filter((function(t){return t!==e.index})),"transparent"===t?i.unshift(e.index):i.push(e.index),this.stacks[t].programs["program-"+e._program.id]=i,this.stacks[t].order=this.stacks[t].order.filter((function(t){return t!==e._program.id})),this.stacks[t].order.push(e._program.id)}},{key:"addShaderPass",value:function(e){e._isScenePass?this.stacks.scenePasses.push(e.index):this.stacks.renderPasses.push(e.index)}},{key:"removeShaderPass",value:function(e){this.resetShaderPassStacks()}},{key:"drawStack",value:function(e){for(var t=0;t<this.stacks[e].order.length;t++)for(var i=this.stacks[e].order[t],r=this.stacks[e].programs["program-"+i],s=0;s<r.length;s++){var a=this.renderer.planes[r[s]];a&&a._startDrawing()}}},{key:"enableShaderPass",value:function(){this.stacks.scenePasses.length>0&&0===this.stacks.renderPasses.length&&(this.renderer.state.scenePassIndex=0,this.renderer.bindFrameBuffer(this.renderer.shaderPasses[this.stacks.scenePasses[0]].target))}},{key:"drawShaderPasses",value:function(){this.stacks.scenePasses.length>0&&this.stacks.renderPasses.length>0&&(this.renderer.state.scenePassIndex=0,this.renderer.bindFrameBuffer(this.renderer.shaderPasses[this.stacks.scenePasses[0]].target));for(var e=0;e<this.stacks.renderPasses.length;e++)this.renderer.shaderPasses[this.stacks.renderPasses[e]]._startDrawing();if(this.stacks.scenePasses.length>0)for(var t=0;t<this.stacks.scenePasses.length;t++)this.renderer.shaderPasses[this.stacks.scenePasses[t]]._startDrawing()}},{key:"draw",value:function(){this.enableShaderPass(),this.drawStack("opaque"),this.stacks.transparent.length&&(this.gl.clearDepth(1),this.gl.clear(this.gl.DEPTH_BUFFER_BIT),this.drawStack("transparent")),this.drawShaderPasses()}}]),e}(),n=function(){function e(){_classCallCheck(this,e),this.geometries=[],this.clear()}return _createClass(e,[{key:"clear",value:function(){this.textures=[],this.programs=[]}},{key:"getGeometryFromID",value:function(e){return this.geometries.find((function(t){return t.id===e}))}},{key:"addGeometry",value:function(e,t,i){this.geometries.push({id:e,vertices:t,uvs:i})}},{key:"isSameShader",value:function(e,t){return 0===e.localeCompare(t)}},{key:"getProgramFromShaders",value:function(e,t){var i=this;return this.programs.find((function(r){return i.isSameShader(r.vsCode,e)&&i.isSameShader(r.fsCode,t)}))}},{key:"addProgram",value:function(e){this.programs.push(e)}},{key:"getTextureFromSource",value:function(e){return this.textures.find((function(t){return t.source&&t.source.src===e.src&&t.uuid!=t.uuid}))}},{key:"addTexture",value:function(e){this.getTextureFromSource(e.source)||this.textures.push(e)}},{key:"removeTexture",value:function(e){this.textures=this.textures.filter((function(t){return t.uuid!==e.uuid}))}}]),e}(),h=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);_classCallCheck(this,e),this.type="Mat4",this.elements=t}return _createClass(e,[{key:"setFromArray",value:function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]=e[t]}},{key:"copy",value:function(e){var t=e.elements;this.elements[0]=t[0],this.elements[1]=t[1],this.elements[2]=t[2],this.elements[3]=t[3],this.elements[4]=t[4],this.elements[5]=t[5],this.elements[6]=t[6],this.elements[7]=t[7],this.elements[8]=t[8],this.elements[9]=t[9],this.elements[10]=t[10],this.elements[11]=t[11],this.elements[12]=t[12],this.elements[13]=t[13],this.elements[14]=t[14],this.elements[15]=t[15]}},{key:"multiply",value:function(t){var i=this.elements,r=t.elements,s=new e;return s.elements[0]=r[0]*i[0]+r[1]*i[4]+r[2]*i[8]+r[3]*i[12],s.elements[1]=r[0]*i[1]+r[1]*i[5]+r[2]*i[9]+r[3]*i[13],s.elements[2]=r[0]*i[2]+r[1]*i[6]+r[2]*i[10]+r[3]*i[14],s.elements[3]=r[0]*i[3]+r[1]*i[7]+r[2]*i[11]+r[3]*i[15],s.elements[4]=r[4]*i[0]+r[5]*i[4]+r[6]*i[8]+r[7]*i[12],s.elements[5]=r[4]*i[1]+r[5]*i[5]+r[6]*i[9]+r[7]*i[13],s.elements[6]=r[4]*i[2]+r[5]*i[6]+r[6]*i[10]+r[7]*i[14],s.elements[7]=r[4]*i[3]+r[5]*i[7]+r[6]*i[11]+r[7]*i[15],s.elements[8]=r[8]*i[0]+r[9]*i[4]+r[10]*i[8]+r[11]*i[12],s.elements[9]=r[8]*i[1]+r[9]*i[5]+r[10]*i[9]+r[11]*i[13],s.elements[10]=r[8]*i[2]+r[9]*i[6]+r[10]*i[10]+r[11]*i[14],s.elements[11]=r[8]*i[3]+r[9]*i[7]+r[10]*i[11]+r[11]*i[15],s.elements[12]=r[12]*i[0]+r[13]*i[4]+r[14]*i[8]+r[15]*i[12],s.elements[13]=r[12]*i[1]+r[13]*i[5]+r[14]*i[9]+r[15]*i[13],s.elements[14]=r[12]*i[2]+r[13]*i[6]+r[14]*i[10]+r[15]*i[14],s.elements[15]=r[12]*i[3]+r[13]*i[7]+r[14]*i[11]+r[15]*i[15],s}},{key:"multiplyMatrices",value:function(e,t){var i=e.elements,r=t.elements,s=i[0],a=i[4],n=i[8],h=i[12],o=i[1],l=i[5],u=i[9],d=i[13],c=i[2],p=i[6],g=i[10],m=i[14],f=i[3],_=i[7],v=i[11],x=i[15],y=r[0],b=r[4],k=r[8],R=r[12],P=r[1],w=r[5],T=r[9],S=r[13],C=r[2],E=r[6],M=r[10],F=r[14],A=r[3],D=r[7],L=r[11],O=r[15];return this.elements[0]=s*y+a*P+n*C+h*A,this.elements[4]=s*b+a*w+n*E+h*D,this.elements[8]=s*k+a*T+n*M+h*L,this.elements[12]=s*R+a*S+n*F+h*O,this.elements[1]=o*y+l*P+u*C+d*A,this.elements[5]=o*b+l*w+u*E+d*D,this.elements[9]=o*k+l*T+u*M+d*L,this.elements[13]=o*R+l*S+u*F+d*O,this.elements[2]=c*y+p*P+g*C+m*A,this.elements[6]=c*b+p*w+g*E+m*D,this.elements[10]=c*k+p*T+g*M+m*L,this.elements[14]=c*R+p*S+g*F+m*O,this.elements[3]=f*y+_*P+v*C+x*A,this.elements[7]=f*b+_*w+v*E+x*D,this.elements[11]=f*k+_*T+v*M+x*L,this.elements[15]=f*R+_*S+v*F+x*O,this}},{key:"scale",value:function(t){var i=this.elements,r=new e;return r.elements[0]=t.x*i[0],r.elements[1]=t.x*i[1],r.elements[2]=t.x*i[2],r.elements[3]=t.x*i[3],r.elements[4]=t.y*i[4],r.elements[5]=t.y*i[5],r.elements[6]=t.y*i[6],r.elements[7]=t.y*i[7],r.elements[8]=t.z*i[8],r.elements[9]=t.z*i[9],r.elements[10]=t.z*i[10],r.elements[11]=t.z*i[11],i!==r.elements&&(r.elements[12]=i[12],r.elements[13]=i[13],r.elements[14]=i[14],r.elements[15]=i[15]),r}},{key:"composeFromOrigin",value:function(e,t,i,r){var s=this.elements,a=t.elements[0],n=t.elements[1],h=t.elements[2],o=t.elements[3],l=a+a,u=n+n,d=h+h,c=a*l,p=a*u,g=a*d,m=n*u,f=n*d,_=h*d,v=o*l,x=o*u,y=o*d,b=i.x,k=i.y,R=i.z,P=r.x,w=r.y,T=r.z,S=(1-(m+_))*b,C=(p+y)*b,E=(g-x)*b,M=(p-y)*k,F=(1-(c+_))*k,A=(f+v)*k,D=(g+x)*R,L=(f-v)*R,O=(1-(c+m))*R;return s[0]=S,s[1]=C,s[2]=E,s[3]=0,s[4]=M,s[5]=F,s[6]=A,s[7]=0,s[8]=D,s[9]=L,s[10]=O,s[11]=0,s[12]=e.x+P-(S*P+M*w+D*T),s[13]=e.y+w-(C*P+F*w+L*T),s[14]=e.z+T-(E*P+A*w+O*T),s[15]=1,this}}]),e}(),o=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,e),this.type="Vec2",this.set(t,i)}return _createClass(e,[{key:"set",value:function(e,t){this.x=e,this.y=t}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"addScalar",value:function(e){return this.x+=e,this.y+=e,this}},{key:"sub",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"subScalar",value:function(e){return this.x-=e,this.y-=e,this}},{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this}},{key:"clone",value:function(){return new e(this.x,this.y)}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y}},{key:"normalize",value:function(){var e=this.x*this.x+this.y*this.y;return e>0&&(e=1/Math.sqrt(e)),this.x*=e,this.y*=e,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}}]),e}(),l=function(){function e(t){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=s.isFBOTexture,n=void 0!==a&&a,l=s.fromTexture,u=void 0!==l&&l,d=s.loader,c=s.sampler,p=s.floatingPoint,g=void 0===p?"none":p,m=s.premultiplyAlpha,f=void 0!==m&&m,_=s.anisotropy,v=void 0===_?1:_,x=s.generateMipmap,y=void 0===x?null:x,b=s.wrapS,k=s.wrapT,R=s.minFilter,P=s.magFilter;if(_classCallCheck(this,e),this.type="Texture",(t=t.renderer||t)&&"Renderer"===t.type?t.gl||i(this.type+": Renderer WebGL context is undefined",t):i(this.type+": Renderer not passed as first argument",t),this.renderer=t,this.gl=this.renderer.gl,this.uuid=r(),this._globalParameters={unpackAlignment:4,flipY:!n,premultiplyAlpha:f,floatingPoint:g,type:this.gl.UNSIGNED_BYTE,internalFormat:this.gl.RGBA,format:this.gl.RGBA},this.parameters={anisotropy:v,generateMipmap:y,wrapS:b||this.gl.CLAMP_TO_EDGE,wrapT:k||this.gl.CLAMP_TO_EDGE,minFilter:R||this.gl.LINEAR,magFilter:P||this.gl.LINEAR,_shouldUpdate:!0},this._initState(),this.sourceType=n?"fbo":"empty",this._samplerName=c,this._sampler={isActive:!1},this._textureMatrix={matrix:new h},this.scale=new o(1,1),this._loader=d,this._sourceLoaded=!1,this._uploaded=!1,this._willUpdate=!1,this.shouldUpdate=!1,this._forceUpdate=!1,this.userData={},this._canDraw=!1,u)return this._copyOnInit=!0,void(this._copiedFrom=u);this._copyOnInit=!1,this._initTexture()}return _createClass(e,[{key:"_initState",value:function(){this._state={anisotropy:1,generateMipmap:!1,wrapS:null,wrapT:null,minFilter:null,magFilter:this.gl.LINEAR}}},{key:"_initTexture",value:function(){this._sampler.texture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this._sampler.texture),"empty"===this.sourceType&&(this.gl.texImage2D(this.gl.TEXTURE_2D,0,this._globalParameters.internalFormat,1,1,0,this._globalParameters.format,this._globalParameters.type,new Uint8Array([0,0,0,255])),this._canDraw=!0)}},{key:"_restoreFromTexture",value:function(){this._copyOnInit||this._initTexture(),this._parent&&(this._setTextureUniforms(),this._setSize()),this.copy(this._copiedFrom),this._canDraw=!0}},{key:"_restoreContext",value:function(){var e=this;if(this._canDraw=!1,this._sampler.isActive=!1,this._initState(),this._state.generateMipmap=!1,this.parameters._shouldUpdate=!0,this._copiedFrom)var t=this.renderer.nextRender.add((function(){e._copiedFrom._canDraw&&(e._restoreFromTexture(),t.keep=!1)}),!0);else this._initTexture(),this._parent&&this._setParent(),this.source&&(this.setSource(this.source),"image"===this.sourceType?this.renderer.cache.addTexture(this):this.needUpdate()),this._canDraw=!0}},{key:"addParent",value:function(e){!e||"Plane"!==e.type&&"ShaderPass"!==e.type&&"RenderTarget"!==e.type?this.renderer.production||t(this.type+": cannot add texture as a child of ",e," because it is not a valid parent"):(this._parent=e,this.index=this._parent.textures.length,this._parent.textures.push(this),this._setParent())}},{key:"_setParent",value:function(){var e=this;if(this._sampler.name=this._samplerName||"uSampler"+this.index,this._textureMatrix.name=this._samplerName?this._samplerName+"Matrix":"uTextureMatrix"+this.index,this._parent._program){if(!this._parent._program.compiled)return void(this.renderer.production||t(this.type+": Unable to create the texture because the program is not valid"));if(this._setTextureUniforms(),this._copyOnInit)return void this.renderer.nextRender.add((function(){return e.copy(e._copiedFrom)}));this.source?this._parent.loader&&this._parent.loader._addSourceToParent(this.source,this.sourceType):this._size={width:this._parent._boundingRect.document.width,height:this._parent._boundingRect.document.height},this._setSize()}else"RenderTarget"===this._parent.type&&(this._size={width:this._parent._size&&this._parent._size.width||this.renderer._boundingRect.width,height:this._parent._size&&this._parent._size.height||this.renderer._boundingRect.height},this._upload(),this._updateTexParameters(),this._canDraw=!0)}},{key:"hasParent",value:function(){return!!this._parent}},{key:"_setTextureUniforms",value:function(){for(var e=0;e<this._parent._program.activeTextures.length;e++)this._parent._program.activeTextures[e]===this._sampler.name&&(this._sampler.isActive=!0,this.renderer.useProgram(this._parent._program),this._sampler.location=this.gl.getUniformLocation(this._parent._program.program,this._sampler.name),this._textureMatrix.location=this.gl.getUniformLocation(this._parent._program.program,this._textureMatrix.name),this.gl.uniform1i(this._sampler.location,this.index))}},{key:"setFromTexture",value:function(e){this.renderer.production||t(this.type+": setFromTexture() is deprecated, use copy() instead"),this.copy(e)}},{key:"copy",value:function(e){e&&"Texture"===e.type?(this.parameters=e.parameters,this._state=e._state,this._size=e._size,this._sourceLoaded=e._sourceLoaded,this._uploaded=e._uploaded,this.sourceType=e.sourceType,this.source=e.source,this._sampler.texture=e._sampler.texture,this._copiedFrom=e,!this._parent||!this._parent._program||this._canDraw&&this._textureMatrix.matrix||(this._setSize(),this._canDraw=!0),this.renderer.needRender()):this.renderer.production||t(this.type+": Unable to set the texture from texture:",e)}},{key:"setSource",value:function(e){var i=this;this._sourceLoaded||this.renderer.nextRender.add((function(){return i._onSourceLoadedCallback&&i._onSourceLoadedCallback()}));var r=this.renderer.cache.getTextureFromSource(e);if(r)return this._uploaded||(this.renderer.nextRender.add((function(){return i._onSourceUploadedCallback&&i._onSourceUploadedCallback()})),this._uploaded=!0),this.copy(r),void this.resize();this.source=e,"empty"===this.sourceType&&("IMG"===e.tagName.toUpperCase()?this.sourceType="image":"VIDEO"===e.tagName.toUpperCase()?(this.sourceType="video",this.shouldUpdate=!0):"CANVAS"===e.tagName.toUpperCase()?(this.sourceType="canvas",this._willUpdate=!0,this.shouldUpdate=!0):this.renderer.production||t(this.type+": this HTML tag could not be converted into a texture:",e.tagName)),this._size={width:this.source.naturalWidth||this.source.width||this.source.videoWidth,height:this.source.naturalHeight||this.source.height||this.source.videoHeight},this._sourceLoaded=!0,this.gl.bindTexture(this.gl.TEXTURE_2D,this._sampler.texture),this.resize(),"image"===this.sourceType&&(this.parameters.generateMipmap=this.parameters.generateMipmap||null===this.parameters.generateMipmap,this.parameters._shouldUpdate=this.parameters.generateMipmap,this._state.generateMipmap=!1,this._upload()),this.renderer.needRender()}},{key:"_updateGlobalTexParameters",value:function(){this.renderer.state.unpackAlignment!==this._globalParameters.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this._globalParameters.unpackAlignment),this.renderer.state.unpackAlignment=this._globalParameters.unpackAlignment),this.renderer.state.flipY!==this._globalParameters.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this._globalParameters.flipY),this.renderer.state.flipY=this._globalParameters.flipY),this.renderer.state.premultiplyAlpha!==this._globalParameters.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this._globalParameters.premultiplyAlpha),this.renderer.state.premultiplyAlpha=this._globalParameters.premultiplyAlpha),"half-float"===this._globalParameters.floatingPoint?this.renderer._isWebGL2&&this.renderer.extensions.EXT_color_buffer_float?(this._globalParameters.internalFormat=this.gl.RGBA16F,this._globalParameters.type=this.gl.HALF_FLOAT):this.renderer.extensions.OES_texture_half_float?this._globalParameters.type=this.renderer.extensions.OES_texture_half_float.HALF_FLOAT_OES:this.renderer.production||t(this.type+": could not use half-float textures because the extension is not available"):"float"===this._globalParameters.floatingPoint&&(this.renderer._isWebGL2&&this.renderer.extensions.EXT_color_buffer_float?(this._globalParameters.internalFormat=this.gl.RGBA16F,this._globalParameters.type=this.gl.FLOAT):this.renderer.extensions.OES_texture_float?this._globalParameters.type=this.renderer.extensions.OES_texture_half_float.FLOAT:this.renderer.production||t(this.type+": could not use float textures because the extension is not available"))}},{key:"_updateTexParameters",value:function(){this.index&&this.renderer.state.activeTexture!==this.index&&this._bindTexture(this),this.parameters.wrapS!==this._state.wrapS&&(this.renderer._isWebGL2||s(this._size.width)&&s(this._size.height)||(this.parameters.wrapS=this.gl.CLAMP_TO_EDGE),this.parameters.wrapS!==this.gl.REPEAT&&this.parameters.wrapS!==this.gl.CLAMP_TO_EDGE&&this.parameters.wrapS!==this.gl.MIRRORED_REPEAT&&(this.renderer.production||t(this.type+": Wrong wrapS value",this.parameters.wrapS,"for this texture:",this,"\ngl.CLAMP_TO_EDGE wrapping will be used instead"),this.parameters.wrapS=this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.parameters.wrapS),this._state.wrapS=this.parameters.wrapS),this.parameters.wrapT!==this._state.wrapT&&(this.renderer._isWebGL2||s(this._size.width)&&s(this._size.height)||(this.parameters.wrapT=this.gl.CLAMP_TO_EDGE),this.parameters.wrapT!==this.gl.REPEAT&&this.parameters.wrapT!==this.gl.CLAMP_TO_EDGE&&this.parameters.wrapT!==this.gl.MIRRORED_REPEAT&&(this.renderer.production||t(this.type+": Wrong wrapT value",this.parameters.wrapT,"for this texture:",this,"\ngl.CLAMP_TO_EDGE wrapping will be used instead"),this.parameters.wrapT=this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.parameters.wrapT),this._state.wrapT=this.parameters.wrapT),this.parameters.generateMipmap&&!this._state.generateMipmap&&this.source&&(this.renderer._isWebGL2||s(this._size.width)&&s(this._size.height)?this.gl.generateMipmap(this.gl.TEXTURE_2D):this.parameters.generateMipmap=!1,this._state.generateMipmap=this.parameters.generateMipmap),this.parameters.minFilter!==this._state.minFilter&&(this.renderer._isWebGL2||s(this._size.width)&&s(this._size.height)||(this.parameters.minFilter=this.gl.LINEAR),this.parameters.generateMipmap||(this.parameters.minFilter=this.gl.LINEAR),this.parameters.minFilter!==this.gl.LINEAR&&this.parameters.minFilter!==this.gl.NEAREST&&this.parameters.minFilter!==this.gl.NEAREST_MIPMAP_NEAREST&&this.parameters.minFilter!==this.gl.LINEAR_MIPMAP_NEAREST&&this.parameters.minFilter!==this.gl.NEAREST_MIPMAP_LINEAR&&this.parameters.minFilter!==this.gl.LINEAR_MIPMAP_LINEAR&&(this.renderer.production||t(this.type+": Wrong minFilter value",this.parameters.minFilter,"for this texture:",this,"\ngl.LINEAR filtering will be used instead"),this.parameters.minFilter=this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.parameters.minFilter),this._state.minFilter=this.parameters.minFilter),this.parameters.magFilter!==this._state.magFilter&&(this.renderer._isWebGL2||s(this._size.width)&&s(this._size.height)||(this.parameters.magFilter=this.gl.LINEAR),this.parameters.magFilter!==this.gl.LINEAR&&this.parameters.magFilter!==this.gl.NEAREST&&(this.renderer.production||t(this.type+": Wrong magFilter value",this.parameters.magFilter,"for this texture:",this,"\ngl.LINEAR filtering will be used instead"),this.parameters.magFilter=this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.parameters.magFilter),this._state.magFilter=this.parameters.magFilter);var e=this.renderer.extensions.EXT_texture_filter_anisotropic;if(e&&this.parameters.anisotropy!==this._state.anisotropy){var i=this.gl.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.parameters.anisotropy=Math.max(1,Math.min(this.parameters.anisotropy,i)),this.gl.texParameterf(this.gl.TEXTURE_2D,e.TEXTURE_MAX_ANISOTROPY_EXT,this.parameters.anisotropy),this._state.anisotropy=this.parameters.anisotropy}}},{key:"setWrapS",value:function(e){this.parameters.wrapS!==e&&(this.parameters.wrapS=e,this.parameters._shouldUpdate=!0)}},{key:"setWrapT",value:function(e){this.parameters.wrapT!==e&&(this.parameters.wrapT=e,this.parameters._shouldUpdate=!0)}},{key:"setMinFilter",value:function(e){this.parameters.minFilter!==e&&(this.parameters.minFilter=e,this.parameters._shouldUpdate=!0)}},{key:"setMagFilter",value:function(e){this.parameters.magFilter!==e&&(this.parameters.magFilter=e,this.parameters._shouldUpdate=!0)}},{key:"setAnisotropy",value:function(e){e=isNaN(e)?this.parameters.anisotropy:e,this.parameters.anisotropy!==e&&(this.parameters.anisotropy=e,this.parameters._shouldUpdate=!0)}},{key:"needUpdate",value:function(){this._forceUpdate=!0}},{key:"_videoFrameCallback",value:function(){var e=this;this._willUpdate=!0,this.source.requestVideoFrameCallback((function(){return e._videoFrameCallback()}))}},{key:"_upload",value:function(){var e=this;this._updateGlobalTexParameters(),this.source?this.gl.texImage2D(this.gl.TEXTURE_2D,0,this._globalParameters.internalFormat,this._globalParameters.format,this._globalParameters.type,this.source):"fbo"===this.sourceType&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this._globalParameters.internalFormat,this._size.width,this._size.height,0,this._globalParameters.format,this._globalParameters.type,this.source),this._uploaded||(this.renderer.nextRender.add((function(){return e._onSourceUploadedCallback&&e._onSourceUploadedCallback()})),this._uploaded=!0)}},{key:"_getSizes",value:function(){if("fbo"===this.sourceType)return{parentWidth:this._parent._boundingRect.document.width,parentHeight:this._parent._boundingRect.document.height,sourceWidth:this._parent._boundingRect.document.width,sourceHeight:this._parent._boundingRect.document.height,xOffset:0,yOffset:0};var e=this._parent.scale?new o(this._parent.scale.x,this._parent.scale.y):new o(1,1),t=this._parent._boundingRect.document.width*e.x,i=this._parent._boundingRect.document.height*e.y,r=this._size.width,s=this._size.height,a=r/s,n=t/i,h=0,l=0;return n>a?l=Math.min(0,i-t*(1/a)):n<a&&(h=Math.min(0,t-i*a)),{parentWidth:t,parentHeight:i,sourceWidth:r,sourceHeight:s,xOffset:h,yOffset:l}}},{key:"setScale",value:function(e,t){e=isNaN(e)?this.scale.x:parseFloat(e),t=isNaN(t)?this.scale.y:parseFloat(t),e=Math.max(e,.001),t=Math.max(t,.001),e===this.scale.x&&t===this.scale.y||(this.scale.set(e,t),this.resize())}},{key:"_setSize",value:function(){if(this._parent&&this._parent._program){var e=this._getSizes();this._updateTextureMatrix(e)}}},{key:"resize",value:function(){"fbo"===this.sourceType?(this._size={width:this._parent._size&&this._parent._size.width||this._parent._boundingRect.document.width,height:this._parent._size&&this._parent._size.height||this._parent._boundingRect.document.height},this._copiedFrom||(this.gl.bindTexture(this.gl.TEXTURE_2D,this._sampler.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this._globalParameters.internalFormat,this._size.width,this._size.height,0,this._globalParameters.format,this._globalParameters.type,null))):this.source&&(this._size={width:this.source.naturalWidth||this.source.width||this.source.videoWidth,height:this.source.naturalHeight||this.source.height||this.source.videoHeight}),this._setSize()}},{key:"_updateTextureMatrix",value:function(e){var t=new o(e.parentWidth/(e.parentWidth-e.xOffset),e.parentHeight/(e.parentHeight-e.yOffset));t.x/=this.scale.x,t.y/=this.scale.y;var i=new h([1,0,0,0,0,1,0,0,0,0,1,0,(1-t.x)/2,(1-t.y)/2,0,1]);this._textureMatrix.matrix=i.scale(t),this.renderer.useProgram(this._parent._program),this.gl.uniformMatrix4fv(this._textureMatrix.location,!1,this._textureMatrix.matrix.elements)}},{key:"_onSourceLoaded",value:function(e){this.setSource(e),"image"===this.sourceType&&this.renderer.cache.addTexture(this)}},{key:"_bindTexture",value:function(){this._canDraw&&(this.renderer.state.activeTexture!==this.index&&(this.gl.activeTexture(this.gl.TEXTURE0+this.index),this.renderer.state.activeTexture=this.index),this.gl.bindTexture(this.gl.TEXTURE_2D,this._sampler.texture))}},{key:"_draw",value:function(){this._sampler.isActive&&(this._bindTexture(this),"video"===this.sourceType&&this.source&&!this.source.hasVideoFrameCallback&&this.source.readyState>=this.source.HAVE_CURRENT_DATA&&!this.source.paused&&(this._willUpdate=!0),(this._forceUpdate||this._willUpdate&&this.shouldUpdate)&&(this._state.generateMipmap=!1,this._upload()),"video"===this.sourceType&&(this._willUpdate=!1),this._forceUpdate=!1),this.parameters._shouldUpdate&&(this._updateTexParameters(),this.parameters._shouldUpdate=!1)}},{key:"onSourceLoaded",value:function(e){return e&&(this._onSourceLoadedCallback=e),this}},{key:"onSourceUploaded",value:function(e){return e&&(this._onSourceUploadedCallback=e),this}},{key:"_dispose",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];"video"===this.sourceType||"image"===this.sourceType&&!this.renderer.state.isActive?(this._loader&&this._loader.removeSource(this),this.source=null):"canvas"===this.sourceType&&(this.source.width=this.source.width,this.source=null),this._parent=null;var t=this.gl&&!this._copiedFrom&&(e||"image"!==this.sourceType||!this.renderer.state.isActive);t&&(this.renderer.cache.removeTexture(this),this.gl.activeTexture(this.gl.TEXTURE0+this.index),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.deleteTexture(this._sampler.texture))}}]),e}(),u=function(){function e(t){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=s.shaderPass,n=s.depth,h=void 0!==n&&n,o=s.clear,l=void 0===o||o,u=s.minWidth,d=void 0===u?1024:u,c=s.minHeight,p=void 0===c?1024:c,g=s.texturesOptions,m=void 0===g?{}:g;_classCallCheck(this,e),this.type="RenderTarget",(t=t.renderer||t)&&"Renderer"===t.type?t.gl||i(this.type+": Renderer WebGL context is undefined",t):i(this.type+": Renderer not passed as first argument",t),this.renderer=t,this.gl=this.renderer.gl,this.index=this.renderer.renderTargets.length,this._shaderPass=a,this._depth=h,this._shouldClear=l,this._minSize={width:d*this.renderer.pixelRatio,height:p*this.renderer.pixelRatio},m=Object.assign({sampler:"uRenderTexture",isFBOTexture:!0,premultiplyAlpha:!1,anisotropy:1,generateMipmap:!1,floatingPoint:"none",wrapS:this.gl.CLAMP_TO_EDGE,wrapT:this.gl.CLAMP_TO_EDGE,minFilter:this.gl.LINEAR,magFilter:this.gl.LINEAR},m),this._texturesOptions=m,this.userData={},this.uuid=r(),this.renderer.renderTargets.push(this),this.renderer.onSceneChange(),this._initRenderTarget()}return _createClass(e,[{key:"_initRenderTarget",value:function(){this._setSize(),this.textures=[],this._createFrameBuffer()}},{key:"_restoreContext",value:function(){this._setSize(),this._createFrameBuffer()}},{key:"_setSize",value:function(){this._shaderPass&&this._shaderPass._isScenePass?this._size={width:this.renderer._boundingRect.width,height:this.renderer._boundingRect.height}:this._size={width:Math.max(this._minSize.width,this.renderer._boundingRect.width),height:Math.max(this._minSize.height,this.renderer._boundingRect.height)}}},{key:"resize",value:function(){this._shaderPass&&(this._setSize(),this.textures[0].resize(),this.renderer.bindFrameBuffer(this,!0),this._depth&&this._bindDepthBuffer(),this.renderer.bindFrameBuffer(null))}},{key:"_bindDepthBuffer",value:function(){this._depthBuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this._depthBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this._size.width,this._size.height),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this._depthBuffer))}},{key:"_createFrameBuffer",value:function(){(this._frameBuffer=this.gl.createFramebuffer(),this.renderer.bindFrameBuffer(this,!0),this.textures.length)?(this.textures[0]._parent=this,this.textures[0]._restoreContext()):new l(this.renderer,this._texturesOptions).addParent(this);this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.textures[0]._sampler.texture,0),this._depth&&(this._depthBuffer=this.gl.createRenderbuffer(),this._bindDepthBuffer()),this.renderer.bindFrameBuffer(null)}},{key:"remove",value:function(){this._shaderPass?this.renderer.production||t(this.type+": You're trying to remove a RenderTarget attached to a ShaderPass. You should remove that ShaderPass instead:",this._shaderPass):(this._dispose(),this.renderer.removeRenderTarget(this))}},{key:"_dispose",value:function(){this._frameBuffer&&(this.gl.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null),this._depthBuffer&&(this.gl.deleteRenderbuffer(this._depthBuffer),this._depthBuffer=null),this.textures[0]._dispose(),this.textures=[]}}]),e}(),d=function(){function e(t,r,s,a){if(_classCallCheck(this,e),this.type="Uniforms",t&&"Renderer"===t.type?t.gl||i(this.type+": Renderer WebGL context is undefined",t):i(this.type+": Renderer not passed as first argument",t),this.renderer=t,this.gl=t.gl,this.program=r,this.shared=s,this.uniforms={},a)for(var n in a){var h=a[n];this.uniforms[n]={name:h.name,type:h.type,value:h.value,lastValue:h.value,update:null}}}return _createClass(e,[{key:"handleUniformSetting",value:function(e){switch(e.type){case"1i":e.update=this.setUniform1i.bind(this);break;case"1iv":e.update=this.setUniform1iv.bind(this);break;case"1f":e.update=this.setUniform1f.bind(this);break;case"1fv":e.update=this.setUniform1fv.bind(this);break;case"2i":e.update=this.setUniform2i.bind(this);break;case"2iv":e.update=this.setUniform2iv.bind(this);break;case"2f":e.update=this.setUniform2f.bind(this);break;case"2fv":e.update=this.setUniform2fv.bind(this);break;case"3i":e.update=this.setUniform3i.bind(this);break;case"3iv":e.update=this.setUniform3iv.bind(this);break;case"3f":e.update=this.setUniform3f.bind(this);break;case"3fv":e.update=this.setUniform3fv.bind(this);break;case"4i":e.update=this.setUniform4i.bind(this);break;case"4iv":e.update=this.setUniform4iv.bind(this);break;case"4f":e.update=this.setUniform4f.bind(this);break;case"4fv":e.update=this.setUniform4fv.bind(this);break;case"mat2":e.update=this.setUniformMatrix2fv.bind(this);break;case"mat3":e.update=this.setUniformMatrix3fv.bind(this);break;case"mat4":e.update=this.setUniformMatrix4fv.bind(this);break;default:this.renderer.production||t(this.type+": This uniform type is not handled : ",e.type)}}},{key:"setInternalFormat",value:function(e){"Vec2"===e.value.type?e._internalFormat="Vec2":"Vec3"===e.value.type?e._internalFormat="Vec3":"Mat4"===e.value.type?e._internalFormat="Mat4":Array.isArray(e.value)?e._internalFormat="array":e.value.constructor===Float32Array?e._internalFormat="mat":e._internalFormat="float"}},{key:"setUniforms",value:function(){if(this.uniforms)for(var e in this.uniforms){var i=this.uniforms[e];i.location=this.gl.getUniformLocation(this.program,i.name),i._internalFormat||this.setInternalFormat(i),i.type||("Vec2"===i._internalFormat?i.type="2f":"Vec3"===i._internalFormat?i.type="3f":"Mat4"===i._internalFormat?i.type="mat4":"array"===i._internalFormat?4===i.value.length?(i.type="4f",this.renderer.production||t(this.type+": No uniform type declared for "+i.name+", applied a 4f (array of 4 floats) uniform type")):3===i.value.length?(i.type="3f",this.renderer.production||t(this.type+": No uniform type declared for "+i.name+", applied a 3f (array of 3 floats) uniform type")):2===i.value.length&&(i.type="2f",this.renderer.production||t(this.type+": No uniform type declared for "+i.name+", applied a 2f (array of 2 floats) uniform type")):"mat"===i._internalFormat?16===i.value.length?(i.type="mat4",this.renderer.production||t(this.type+": No uniform type declared for "+i.name+", applied a mat4 (4x4 matrix array) uniform type")):9===i.value.length?(i.type="mat3",this.renderer.production||t(this.type+": No uniform type declared for "+i.name+", applied a mat3 (3x3 matrix array) uniform type")):4===i.value.length&&(i.type="mat2",this.renderer.production||t(this.type+": No uniform type declared for "+i.name+", applied a mat2 (2x2 matrix array) uniform type")):(i.type="1f",this.renderer.production||t(this.type+": No uniform type declared for "+i.name+", applied a 1f (float) uniform type"))),this.handleUniformSetting(i),i.update&&i.update(i)}}},{key:"updateUniforms",value:function(){if(this.uniforms)for(var e in this.uniforms){var t=this.uniforms[e],i=!1;this.shared?i=!0:t.value.length||t.value===t.lastValue?("Vec2"!==t._internalFormat||t.value.equals(t.lastValue))&&("Vec3"!==t._internalFormat||t.value.equals(t.lastValue))?JSON.stringify(t.value)!==JSON.stringify(t.lastValue)&&(i=!0,t.lastValue=Array.from(t.value)):(i=!0,t.lastValue.copy(t.value)):(i=!0,t.lastValue=t.value),i&&t.update&&t.update(t)}}},{key:"setUniform1i",value:function(e){this.gl.uniform1i(e.location,e.value)}},{key:"setUniform1iv",value:function(e){this.gl.uniform1iv(e.location,e.value)}},{key:"setUniform1f",value:function(e){this.gl.uniform1f(e.location,e.value)}},{key:"setUniform1fv",value:function(e){this.gl.uniform1fv(e.location,e.value)}},{key:"setUniform2i",value:function(e){"Vec2"===e._internalFormat?this.gl.uniform2i(e.location,e.value.x,e.value.y):this.gl.uniform2i(e.location,e.value[0],e.value[1])}},{key:"setUniform2iv",value:function(e){"Vec2"===e._internalFormat?this.gl.uniform2iv(e.location,[e.value.x,e.value.y]):this.gl.uniform2iv(e.location,e.value)}},{key:"setUniform2f",value:function(e){"Vec2"===e._internalFormat?this.gl.uniform2f(e.location,e.value.x,e.value.y):this.gl.uniform2f(e.location,e.value[0],e.value[1])}},{key:"setUniform2fv",value:function(e){"Vec2"===e._internalFormat?this.gl.uniform2fv(e.location,[e.value.x,e.value.y]):this.gl.uniform2fv(e.location,e.value)}},{key:"setUniform3i",value:function(e){"Vec3"===e._internalFormat?this.gl.uniform3i(e.location,e.value.x,e.value.y,e.value.z):this.gl.uniform3i(e.location,e.value[0],e.value[1],e.value[2])}},{key:"setUniform3iv",value:function(e){"Vec3"===e._internalFormat?this.gl.uniform3iv(e.location,[e.value.x,e.value.y,e.value.z]):this.gl.uniform3iv(e.location,e.value)}},{key:"setUniform3f",value:function(e){"Vec3"===e._internalFormat?this.gl.uniform3f(e.location,e.value.x,e.value.y,e.value.z):this.gl.uniform3f(e.location,e.value[0],e.value[1],e.value[2])}},{key:"setUniform3fv",value:function(e){"Vec3"===e._internalFormat?this.gl.uniform3fv(e.location,[e.value.x,e.value.y,e.value.z]):this.gl.uniform3fv(e.location,e.value)}},{key:"setUniform4i",value:function(e){this.gl.uniform4i(e.location,e.value[0],e.value[1],e.value[2],e.value[3])}},{key:"setUniform4iv",value:function(e){this.gl.uniform4iv(e.location,e.value)}},{key:"setUniform4f",value:function(e){this.gl.uniform4f(e.location,e.value[0],e.value[1],e.value[2],e.value[3])}},{key:"setUniform4fv",value:function(e){this.gl.uniform4fv(e.location,e.value)}},{key:"setUniformMatrix2fv",value:function(e){this.gl.uniformMatrix2fv(e.location,!1,e.value)}},{key:"setUniformMatrix3fv",value:function(e){this.gl.uniformMatrix3fv(e.location,!1,e.value)}},{key:"setUniformMatrix4fv",value:function(e){"Mat4"===e._internalFormat?this.gl.uniformMatrix4fv(e.location,e.value.elements):this.gl.uniformMatrix4fv(e.location,e.value)}}]),e}(),c=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=r.parent,a=r.vertexShader,n=r.fragmentShader;_classCallCheck(this,e),this.type="Program",t&&"Renderer"===t.type?t.gl||i(this.type+": Renderer WebGL context is undefined",t):i(this.type+": Renderer not passed as first argument",t),this.renderer=t,this.gl=this.renderer.gl,this.parent=s,this.vsCode=a,this.fsCode=n,this.compiled=!0,this.setupProgram()}return _createClass(e,[{key:"createShader",value:function(e,r){var s=this.gl.createShader(r);if(this.gl.shaderSource(s,e),this.gl.compileShader(s),!this.renderer.production&&!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)){for(var a=r===this.gl.VERTEX_SHADER?"vertex shader":"fragment shader",n=this.gl.getShaderSource(s).split("\n"),h=0;h<n.length;h++)n[h]=h+1+": "+n[h];return n=n.join("\n"),t(this.type+": Errors occurred while compiling the",a,":\n",this.gl.getShaderInfoLog(s)),i(n),this.compiled=!1,null}return s}},{key:"useNewShaders",value:function(){this.vertexShader=this.createShader(this.vsCode,this.gl.VERTEX_SHADER),this.fragmentShader=this.createShader(this.fsCode,this.gl.FRAGMENT_SHADER),this.vertexShader&&this.fragmentShader||this.renderer.production||t(this.type+": Unable to find or compile the vertex or fragment shader")}},{key:"setupProgram",value:function(){var e=this.renderer.cache.getProgramFromShaders(this.vsCode,this.fsCode);e?this.parent.shareProgram?(this.shared=!0,this.vertexShader=e.vertexShader,this.fragmentShader=e.fragmentShader,this.program=e.program,this.id=e.id,this.activeTextures=e.activeTextures):(this.vertexShader=e.vertexShader,this.fragmentShader=e.fragmentShader,this.activeTextures=e.activeTextures,this.createProgram()):(this.useNewShaders(),this.compiled&&this.createProgram())}},{key:"createProgram",value:function(){if(this.id=this.renderer.cache.programs.length,this.shared=this.parent.shareProgram,this.program=this.gl.createProgram(),this.gl.attachShader(this.program,this.vertexShader),this.gl.attachShader(this.program,this.fragmentShader),this.gl.linkProgram(this.program),this.gl.deleteShader(this.vertexShader),this.gl.deleteShader(this.fragmentShader),!this.renderer.production&&!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))return t(this.type+": Unable to initialize the shader program."),void(this.compiled=!1);if(!this.activeTextures){this.activeTextures=[];for(var e=this.gl.getProgramParameter(this.program,this.gl.ACTIVE_UNIFORMS),i=0;i<e;i++){var r=this.gl.getActiveUniform(this.program,i);r.type===this.gl.SAMPLER_2D&&this.activeTextures.push(r.name)}}this.renderer.cache.addProgram(this)}},{key:"createUniforms",value:function(e){this.uniformsManager=new d(this.renderer,this.program,this.shared,e),this.setUniforms()}},{key:"setUniforms",value:function(){this.renderer.useProgram(this),this.uniformsManager.setUniforms()}},{key:"updateUniforms",value:function(){this.renderer.useProgram(this),this.uniformsManager.updateUniforms()}}]),e}(),p=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=(r.program,r.width),a=void 0===s?1:s,n=r.height,h=void 0===n?1:n;_classCallCheck(this,e),this.type="Geometry",t&&"Renderer"===t.type?t.gl||i(this.type+": Renderer WebGL context is undefined",t):i(this.type+": Renderer not passed as first argument",t),this.renderer=t,this.gl=this.renderer.gl,this.definition={id:a*h+a,width:a,height:h},this.setDefaultAttributes(),this.setVerticesUVs()}return _createClass(e,[{key:"restoreContext",value:function(e){this.program=null,this.setDefaultAttributes(),this.setVerticesUVs(),this.setProgram(e)}},{key:"setDefaultAttributes",value:function(){this.attributes={vertexPosition:{name:"aVertexPosition",size:3},textureCoord:{name:"aTextureCoord",size:3}}}},{key:"setVerticesUVs",value:function(){var e=this.renderer.cache.getGeometryFromID(this.definition.id);e?(this.attributes.vertexPosition.array=e.vertices,this.attributes.textureCoord.array=e.uvs):(this.computeVerticesUVs(),this.renderer.cache.addGeometry(this.definition.id,this.attributes.vertexPosition.array,this.attributes.textureCoord.array))}},{key:"setProgram",value:function(e){this.program=e.program,this.initAttributes(),this.renderer._isWebGL2?(this._vao=this.gl.createVertexArray(),this.gl.bindVertexArray(this._vao)):this.renderer.extensions.OES_vertex_array_object&&(this._vao=this.renderer.extensions.OES_vertex_array_object.createVertexArrayOES(),this.renderer.extensions.OES_vertex_array_object.bindVertexArrayOES(this._vao)),this.initializeBuffers()}},{key:"initAttributes",value:function(){for(var e in this.attributes)this.attributes[e].location=this.gl.getAttribLocation(this.program,this.attributes[e].name),this.attributes[e].buffer=this.gl.createBuffer(),this.attributes[e].numberOfItems=this.definition.width*this.definition.height*this.attributes[e].size*2}},{key:"computeVerticesUVs",value:function(){this.attributes.vertexPosition.array=[],this.attributes.textureCoord.array=[];for(var e=this.attributes.vertexPosition.array,t=this.attributes.textureCoord.array,i=0;i<this.definition.height;i++)for(var r=i/this.definition.height,s=0;s<this.definition.width;s++){var a=s/this.definition.width;t.push(a),t.push(r),t.push(0),e.push(2*(a-.5)),e.push(2*(r-.5)),e.push(0),t.push(a+1/this.definition.width),t.push(r),t.push(0),e.push(2*(a+1/this.definition.width-.5)),e.push(2*(r-.5)),e.push(0),t.push(a),t.push(r+1/this.definition.height),t.push(0),e.push(2*(a-.5)),e.push(2*(r+1/this.definition.height-.5)),e.push(0),t.push(a),t.push(r+1/this.definition.height),t.push(0),e.push(2*(a-.5)),e.push(2*(r+1/this.definition.height-.5)),e.push(0),t.push(a+1/this.definition.width),t.push(r),t.push(0),e.push(2*(a+1/this.definition.width-.5)),e.push(2*(r-.5)),e.push(0),t.push(a+1/this.definition.width),t.push(r+1/this.definition.height),t.push(0),e.push(2*(a+1/this.definition.width-.5)),e.push(2*(r+1/this.definition.height-.5)),e.push(0)}}},{key:"initializeBuffers",value:function(){if(this.attributes)for(var e in this.attributes)this.gl.enableVertexAttribArray(this.attributes[e].location),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attributes[e].buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.attributes[e].array),this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.attributes[e].location,this.attributes[e].size,this.gl.FLOAT,!1,0,0)}},{key:"bindBuffers",value:function(){if(this._vao)this.renderer._isWebGL2?this.gl.bindVertexArray(this._vao):this.renderer.extensions.OES_vertex_array_object.bindVertexArrayOES(this._vao);else for(var e in this.attributes)this.gl.enableVertexAttribArray(this.attributes[e].location),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attributes[e].buffer),this.gl.vertexAttribPointer(this.attributes[e].location,this.attributes[e].size,this.gl.FLOAT,!1,0,0)}},{key:"draw",value:function(){this.gl.drawArrays(this.gl.TRIANGLES,0,this.attributes.vertexPosition.numberOfItems)}},{key:"dispose",value:function(){for(var e in this._vao&&(this.renderer._isWebGL2?this.gl.deleteVertexArray(this._vao):this.renderer.extensions.OES_vertex_array_object.deleteVertexArrayOES(this._vao)),this.attributes)this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attributes[e].buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,1,this.gl.STATIC_DRAW),this.gl.deleteBuffer(this.attributes[e].buffer);this.attributes=null}}]),e}(),g=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"TextureLoader",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"anonymous";_classCallCheck(this,e),this.type=r,(t=t.renderer||t)&&"Renderer"===t.type?t.gl||i(this.type+": Renderer WebGL context is undefined",t):i(this.type+": Renderer not passed as first argument",t),this.renderer=t,this.gl=this.renderer.gl,this.crossOrigin=s,this.els=[]}return _createClass(e,[{key:"addElement",value:function(e,t,i,r){var s={source:e,texture:t,load:this._sourceLoaded.bind(this,e,t,i),error:this._sourceLoadError.bind(this,e,r)};return this.els.push(s),s}},{key:"_sourceLoadError",value:function(e,t,i){t&&t(e,i)}},{key:"_sourceLoaded",value:function(e,t,i){var r=this;t._sourceLoaded||(t._onSourceLoaded(e),this._parent&&(this._increment&&this._increment(),this.renderer.nextRender.add((function(){return r._parent._onLoadingCallback&&r._parent._onLoadingCallback(t)})))),i&&i(t)}},{key:"loadSource",value:function(e,t,i,r){return"IMG"===e.tagName.toUpperCase()?this.loadImage(e,t,i,r):"VIDEO"===e.tagName.toUpperCase()?this.loadVideo(e,t,i,r):"CANVAS"===e.tagName.toUpperCase()?this.loadCanvas(e,t,i):this._sourceLoadError(e,r,"this HTML tag could not be converted into a texture: "+e.tagName)}},{key:"loadImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;e.crossOrigin=this.crossOrigin,this._parent&&(t=Object.assign(t,this._parent._texturesOptions));var s=this.renderer.cache.getTextureFromSource(e);if(s){var a=new l(this.renderer,{loader:this,fromTexture:s,sampler:t.sampler||e.getAttribute("data-sampler"),premultiplyAlpha:t.premultiplyAlpha,anisotropy:t.anisotropy,generateMipmap:t.generateMipmap,wrapS:t.wrapS,wrapT:t.wrapT,minFilter:t.minFilter,magFilter:t.magFilter});return i&&i(a),this._parent&&this._addToParent(a,e,"image"),a}var n=new l(this.renderer,{loader:this,sampler:t.sampler||e.getAttribute("data-sampler"),premultiplyAlpha:t.premultiplyAlpha,anisotropy:t.anisotropy,generateMipmap:t.generateMipmap,wrapS:t.wrapS,wrapT:t.wrapT,minFilter:t.minFilter,magFilter:t.magFilter}),h=this.addElement(e,n,i,r);e.complete?this._sourceLoaded(e,n,i):e.decode?e.decode().then(this._sourceLoaded.bind(this,e,n,i)).catch((function(){e.addEventListener("load",h.load,!1),e.addEventListener("error",h.error,!1)})):(e.addEventListener("load",h.load,!1),e.addEventListener("error",h.error,!1)),this._parent&&this._addToParent(n,e,"image")}},{key:"loadVideo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;e.preload=!0,e.muted=!0,e.loop=!0,e.playsinline=!0,e.crossOrigin=this.crossOrigin,this._parent&&(t=Object.assign(t,this._parent._texturesOptions));var s=new l(this.renderer,{loader:this,sampler:t.sampler||e.getAttribute("data-sampler"),premultiplyAlpha:t.premultiplyAlpha,anisotropy:t.anisotropy,generateMipmap:t.generateMipmap,wrapS:t.wrapS,wrapT:t.wrapT,minFilter:t.minFilter,magFilter:t.magFilter}),a=this.addElement(e,s,i,r);e.addEventListener("canplaythrough",a.load,!1),e.addEventListener("error",a.error,!1),e.readyState>=e.HAVE_FUTURE_DATA&&i&&this._sourceLoaded(e,s,i),e.load(),this._addToParent&&this._addToParent(s,e,"video"),"requestVideoFrameCallback"in HTMLVideoElement.prototype&&(a.videoFrameCallback=s._videoFrameCallback.bind(s),e.hasVideoFrameCallback=!0,e.requestVideoFrameCallback(a.videoFrameCallback))}},{key:"loadCanvas",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;this._parent&&(t=Object.assign(t,this._parent._texturesOptions));var r=new l(this.renderer,{loader:this,sampler:t.sampler||e.getAttribute("data-sampler"),premultiplyAlpha:t.premultiplyAlpha,anisotropy:t.anisotropy,generateMipmap:t.generateMipmap,wrapS:t.wrapS,wrapT:t.wrapT,minFilter:t.minFilter,magFilter:t.magFilter});this.addElement(e,r,i,null),this._sourceLoaded(e,r,i),this._parent&&this._addToParent(r,e,"canvas")}},{key:"removeSource",value:function(e){var t=this.els.find((function(t){return t.texture.uuid===e.uuid}));t&&("image"===e.sourceType?t.source.removeEventListener("load",t.load,!1):"video"===e.sourceType&&(t.videoFrameCallback&&t.source.cancelVideoFrameCallback(t.videoFrameCallback),t.source.removeEventListener("canplaythrough",t.load,!1),t.source.pause(),t.source.removeAttribute("src"),t.source.load()),t.source.removeEventListener("error",t.error,!1))}}]),e}(),m=function(e){_inherits(r,e);var i=_createSuper(r);function r(e,s){var a,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},h=n.sourcesLoaded,o=void 0===h?0:h,l=n.sourcesToLoad,u=void 0===l?0:l,d=n.complete,c=void 0!==d&&d,p=n.onComplete,g=void 0===p?function(){}:p;return _classCallCheck(this,r),(a=i.call(this,e,"PlaneTextureLoader",s.crossOrigin))._parent=s,"Plane"!==a._parent.type&&"ShaderPass"!==a._parent.type&&(t(a.type+": Wrong parent type assigned to this loader"),a._parent=null),a.sourcesLoaded=o,a.sourcesToLoad=u,a.complete=c,a.onComplete=g,a}return _createClass(r,[{key:"_setLoaderSize",value:function(e){var t=this;this.sourcesToLoad=e,0===this.sourcesToLoad&&(this.complete=!0,this.renderer.nextRender.add((function(){return t.onComplete&&t.onComplete()})))}},{key:"_increment",value:function(){var e=this;this.sourcesLoaded++,this.sourcesLoaded>=this.sourcesToLoad&&!this.complete&&(this.complete=!0,this.renderer.nextRender.add((function(){return e.onComplete&&e.onComplete()})))}},{key:"_addSourceToParent",value:function(e,t){if("image"===t){var i=this._parent.images;!i.find((function(t){return t.src===e.src}))&&i.push(e)}else if("video"===t){var r=this._parent.videos;!r.find((function(t){return t.src===e.src}))&&r.push(e)}else if("canvas"===t){var s=this._parent.canvases;!s.find((function(t){return t.isEqualNode(e)}))&&s.push(e)}}},{key:"_addToParent",value:function(e,t,i){this._addSourceToParent(t,i),this._parent&&e.addParent(this._parent)}}]),r}(g),f="\nprecision mediump float;\n".replace(/\n/g,""),_="\nattribute vec3 aVertexPosition;\nattribute vec2 aTextureCoord;\n".replace(/\n/g,""),v="\nvarying vec3 vVertexPosition;\nvarying vec2 vTextureCoord;\n".replace(/\n/g,""),x=(f+_+v+"\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\n\nvoid main() {\n    vTextureCoord = aTextureCoord;\n    vVertexPosition = aVertexPosition;\n    \n    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);\n}\n").replace(/\n/g,""),y=(f+v+"\nvoid main() {\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n").replace(/\n/g,""),b=(f+_+v+"\nvoid main() {\n    vTextureCoord = aTextureCoord;\n    vVertexPosition = aVertexPosition;\n    \n    gl_Position = vec4(aVertexPosition, 1.0);\n}\n").replace(/\n/g,""),k=(f+v+"\nuniform sampler2D uRenderTexture;\n\nvoid main() {\n    gl_FragColor = texture2D(uRenderTexture, vTextureCoord);\n}\n").replace(/\n/g,""),R=function(e){_inherits(r,e);var i=_createSuper(r);function r(e,s){var a,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"DOMMesh",h=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=h.shareProgram,l=h.widthSegments,u=h.heightSegments,d=h.depthTest,c=h.cullFace,p=h.uniforms,g=h.vertexShaderID,m=h.fragmentShaderID,f=h.vertexShader,_=h.fragmentShader,v=h.texturesOptions,x=h.crossOrigin;return _classCallCheck(this,r),g=g||s&&s.getAttribute("data-vs-id"),m=m||s&&s.getAttribute("data-fs-id"),(a=i.call(this,e,n,{shareProgram:o,widthSegments:l,heightSegments:u,depthTest:d,cullFace:c,uniforms:p,vertexShaderID:g,fragmentShaderID:m,vertexShader:f,fragmentShader:_,texturesOptions:v,crossOrigin:x})).htmlElement=s,a.htmlElement&&0!==a.htmlElement.length||a.renderer.production||t(a.type+": The HTML element you specified does not currently exists in the DOM"),a._setDocumentSizes(),a}return _createClass(r,[{key:"_setDocumentSizes",value:function(){var e=this.htmlElement.getBoundingClientRect();this._boundingRect||(this._boundingRect={}),this._boundingRect.document={width:e.width*this.renderer.pixelRatio,height:e.height*this.renderer.pixelRatio,top:e.top*this.renderer.pixelRatio,left:e.left*this.renderer.pixelRatio}}},{key:"getBoundingRect",value:function(){return{width:this._boundingRect.document.width,height:this._boundingRect.document.height,top:this._boundingRect.document.top,left:this._boundingRect.document.left,right:this._boundingRect.document.left+this._boundingRect.document.width,bottom:this._boundingRect.document.top+this._boundingRect.document.height}}},{key:"planeResize",value:function(){this.renderer.production||t(this.type+": planeResize() is deprecated, use resize() instead."),this.resize()}},{key:"resize",value:function(){var e=this;this._setDocumentSizes(),"Plane"===this.type&&(this.setPerspective(this.camera.fov,this.camera.near,this.camera.far),this._applyWorldPositions());for(var t=0;t<this.textures.length;t++)this.textures[t].resize();this.renderer.nextRender.add((function(){return e._onAfterResizeCallback&&e._onAfterResizeCallback()}))}},{key:"mouseToPlaneCoords",value:function(e){var t=this.scale?this.scale:new o(1,1),i=new o((this._boundingRect.document.width-this._boundingRect.document.width*t.x)/2,(this._boundingRect.document.height-this._boundingRect.document.height*t.y)/2),r=this._boundingRect.document.width*t.x/this.renderer.pixelRatio,s=this._boundingRect.document.height*t.y/this.renderer.pixelRatio,a=(this._boundingRect.document.top+i.y)/this.renderer.pixelRatio,n=(this._boundingRect.document.left+i.x)/this.renderer.pixelRatio;return new o((e.x-n)/r*2-1,1-(e.y-a)/s*2)}},{key:"onAfterResize",value:function(e){return e&&(this._onAfterResizeCallback=e),this}}]),r}(function(){function e(r){var s=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Mesh",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},h=n.shareProgram,o=void 0!==h&&h,l=n.vertexShaderID,u=n.fragmentShaderID,d=n.vertexShader,g=n.fragmentShader,m=n.uniforms,f=void 0===m?{}:m,_=n.widthSegments,v=void 0===_?1:_,R=n.heightSegments,P=void 0===R?1:R,w=n.depthTest,T=void 0===w||w,S=n.cullFace,C=void 0===S?"back":S,E=n.texturesOptions,M=void 0===E?{}:E,F=n.crossOrigin,A=void 0===F?"anonymous":F;_classCallCheck(this,e),this.type=a,(r=r.renderer||r)&&"Renderer"===r.type||(i(this.type+": Curtains not passed as first argument or Curtains Renderer is missing",r),setTimeout((function(){s._onErrorCallback&&s._onErrorCallback()}),0)),this.renderer=r,this.gl=this.renderer.gl,this.gl||(this.renderer.production||i(this.type+": Unable to create a "+this.type+" because the Renderer WebGl context is not defined"),setTimeout((function(){s._onErrorCallback&&s._onErrorCallback()}),0)),this._canDraw=!1,this.shareProgram=o,this._depthTest=T,this.cullFace=C,"back"!==this.cullFace&&"front"!==this.cullFace&&"none"!==this.cullFace&&(this.cullFace="back"),this.textures=[],M=Object.assign({premultiplyAlpha:!1,anisotropy:1,floatingPoint:"none",wrapS:this.gl.CLAMP_TO_EDGE,wrapT:this.gl.CLAMP_TO_EDGE,minFilter:this.renderer._isWebGL2&&"Plane"===this.type?this.gl.LINEAR_MIPMAP_NEAREST:this.gl.LINEAR,magFilter:this.gl.LINEAR},M),this._texturesOptions=M,this.crossOrigin=A,d||(l&&document.getElementById(l)?d=document.getElementById(l).innerHTML:(this.renderer.production||"Plane"!==this.type||t("Plane: No vertex shader provided, will use a default one"),d="Plane"===this.type?x:b)),g||(u&&document.getElementById(u)?g=document.getElementById(u).innerHTML:(this.renderer.production||t(this.type+": No fragment shader provided, will use a default one"),g="Plane"===this.type?y:k)),this._initMesh(),v=parseInt(v),P=parseInt(P),this._geometry=new p(this.renderer,{width:v,height:P}),this._program=new c(this.renderer,{parent:this,vertexShader:d,fragmentShader:g}),this._program.compiled?(this._program.createUniforms(f),this.uniforms=this._program.uniformsManager.uniforms,this._geometry.setProgram(this._program),this.renderer.onSceneChange()):this.renderer.nextRender.add((function(){return s._onErrorCallback&&s._onErrorCallback()}))}return _createClass(e,[{key:"_initMesh",value:function(){var e=this;this.uuid=r(),this.loader=new m(this.renderer,this,{sourcesLoaded:0,initSourcesToLoad:0,complete:!1,onComplete:function(){e._onReadyCallback&&e._onReadyCallback(),e.renderer.needRender()}}),this.images=[],this.videos=[],this.canvases=[],this.userData={},this._canDraw=!0}},{key:"_restoreContext",value:function(){this._canDraw=!1,this._matrices&&(this._matrices=null),this._program=new c(this.renderer,{parent:this,vertexShader:this._program.vsCode,fragmentShader:this._program.fsCode}),this._program.compiled&&(this._geometry.restoreContext(this._program),this._program.createUniforms(this.uniforms),this.uniforms=this._program.uniformsManager.uniforms,this._programRestored())}},{key:"setRenderTarget",value:function(e){e&&"RenderTarget"===e.type?this.target=e:this.renderer.production||t(this.type+": Could not set the render target because the argument passed is not a RenderTarget class object",e)}},{key:"createTexture",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=new l(this.renderer,Object.assign(this._texturesOptions,e));return t.addParent(this),t}},{key:"addTexture",value:function(e){e&&"Texture"===e.type?e.addParent(this):this.renderer.production||t(this.type+": cannot add ",e," to this "+this.type+" because it is not a valid texture")}},{key:"loadSources",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,s=0;s<e.length;s++)this.loadSource(e[s],t,i,r)}},{key:"loadSource",value:function(e){var i=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;this.loader.loadSource(e,Object.assign(this._texturesOptions,r),(function(e){s&&s(e)}),(function(e,r){i.renderer.production||t(i.type+": this HTML tag could not be converted into a texture:",e.tagName),a&&a(e,r)}))}},{key:"loadImage",value:function(e){var i=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;this.loader.loadImage(e,Object.assign(this._texturesOptions,r),(function(e){s&&s(e)}),(function(e,r){i.renderer.production||t(i.type+": There has been an error:\n",r,"\nwhile loading this image:\n",e),a&&a(e,r)}))}},{key:"loadVideo",value:function(e){var i=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;this.loader.loadVideo(e,Object.assign(this._texturesOptions,r),(function(e){s&&s(e)}),(function(e,r){i.renderer.production||t(i.type+": There has been an error:\n",r,"\nwhile loading this video:\n",e),a&&a(e,r)}))}},{key:"loadCanvas",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;this.loader.loadCanvas(e,Object.assign(this._texturesOptions,t),(function(e){i&&i(e)}))}},{key:"loadImages",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,s=0;s<e.length;s++)this.loadImage(e[s],t,i,r)}},{key:"loadVideos",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,s=0;s<e.length;s++)this.loadVideo(e[s],t,i,r)}},{key:"loadCanvases",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0,r=0;r<e.length;r++)this.loadCanvas(e[r],t,i)}},{key:"playVideos",value:function(){for(var e=this,i=0;i<this.textures.length;i++){var r=this.textures[i];if("video"===r.sourceType){var s=r.source.play();void 0!==s&&s.catch((function(i){e.renderer.production||t(e.type+": Could not play the video : ",i)}))}}}},{key:"_draw",value:function(){this.renderer.setDepth(this._depthTest),this.renderer.setFaceCulling(this.cullFace),this._program.updateUniforms(),this._geometry.bindBuffers();for(var e=0;e<this.textures.length;e++)this.textures[e]._draw();this._geometry.draw(),this.renderer.state.activeTexture=null,this._onAfterRenderCallback&&this._onAfterRenderCallback()}},{key:"onError",value:function(e){return e&&(this._onErrorCallback=e),this}},{key:"onLoading",value:function(e){return e&&(this._onLoadingCallback=e),this}},{key:"onReady",value:function(e){return e&&(this._onReadyCallback=e),this}},{key:"onRender",value:function(e){return e&&(this._onRenderCallback=e),this}},{key:"onAfterRender",value:function(e){return e&&(this._onAfterRenderCallback=e),this}},{key:"remove",value:function(){this._canDraw=!1,this.target&&this.renderer.bindFrameBuffer(null),this._dispose(),"Plane"===this.type?this.renderer.removePlane(this):"ShaderPass"===this.type&&(this.target&&(this.target._shaderPass=null,this.target.remove(),this.target=null),this.renderer.removeShaderPass(this))}},{key:"_dispose",value:function(){if(this.gl){this._geometry&&this._geometry.dispose(),this.target&&"ShaderPass"===this.type&&(this.renderer.removeRenderTarget(this.target),this.textures.shift());for(var e=0;e<this.textures.length;e++)this.textures[e]._dispose();this.textures=null}}}]),e}()),P=function(e){_inherits(i,e);var t=_createSuper(i);function i(e,r){r.shareProgram,r.widthSegments,r.heightSegments;var s,a=r.depthTest,n=(r.cullFace,r.uniforms),h=r.vertexShaderID,o=r.fragmentShaderID,l=r.vertexShader,u=r.fragmentShader,d=r.texturesOptions,c=r.crossOrigin,p=r.depth,g=void 0!==p&&p,m=r.clear,f=void 0===m||m,_=r.renderTarget;return _classCallCheck(this,i),1,1,"back",!1,(s=t.call(this,e,e.container,"ShaderPass",{shareProgram:!1,widthSegments:1,heightSegments:1,depthTest:a,cullFace:"back",uniforms:n,vertexShaderID:h,fragmentShaderID:o,vertexShader:l,fragmentShader:u,texturesOptions:d,crossOrigin:c}))._isScenePass=!0,s.index=s.renderer.shaderPasses.length,s._depth=g,s._shouldClear=f,s.target=_,s.target&&(s._isScenePass=!1,s._shouldClear=s.target._shouldClear),s._program.compiled&&(s._initShaderPass(),s.renderer.scene.addShaderPass(_assertThisInitialized(s)),s.renderer.shaderPasses.push(_assertThisInitialized(s))),s}return _createClass(i,[{key:"_programRestored",value:function(){this._isScenePass?this.renderer.scene.stacks.scenePasses.push(this.index):this.renderer.scene.stacks.renderPasses.push(this.index);for(var e=0;e<this.textures.length;e++)this.textures[e]._parent=this,this.textures[e]._restoreContext();this._canDraw=!0}},{key:"_initShaderPass",value:function(){this.target?(this.setRenderTarget(this.target),this.target._shaderPass=this):this._createFrameBuffer(),new l(this.renderer,{sampler:"uRenderTexture",isFBOTexture:!0,fromTexture:this.target.textures[0]}).addParent(this),this.loader._setLoaderSize(0),this._canDraw=!0,this.renderer.needRender()}},{key:"_createFrameBuffer",value:function(){var e=new u(this.renderer,{shaderPass:this,clear:this._shouldClear,depth:this._depth});this.setRenderTarget(e)}},{key:"_startDrawing",value:function(){this._canDraw&&(this._onRenderCallback&&this._onRenderCallback(),this._isScenePass?this.renderer.state.scenePassIndex+1<this.renderer.scene.stacks.scenePasses.length?(this.renderer.bindFrameBuffer(this.renderer.shaderPasses[this.renderer.scene.stacks.scenePasses[this.renderer.state.scenePassIndex+1]].target),this.renderer.state.scenePassIndex++):this.renderer.bindFrameBuffer(null):null===this.renderer.state.scenePassIndex&&this.renderer.bindFrameBuffer(null),this._draw())}}]),i}(R),w=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,e),this.type="Vec3",this.set(t,i,r)}return _createClass(e,[{key:"set",value:function(e,t,i){this.x=e,this.y=t,this.z=i}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}},{key:"addScalar",value:function(e){return this.x+=e,this.y+=e,this.z+=e,this}},{key:"sub",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}},{key:"subScalar",value:function(e){return this.x-=e,this.y-=e,this.z-=e,this}},{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}},{key:"clone",value:function(){return new e(this.x,this.y,this.z)}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"normalize",value:function(){var e=this.x*this.x+this.y*this.y+this.z*this.z;return e>0&&(e=1/Math.sqrt(e)),this.x*=e,this.y*=e,this.z*=e,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"applyMat4",value:function(e){var t=this.x,i=this.y,r=this.z,s=e.elements,a=s[3]*t+s[7]*i+s[11]*r+s[15];return a=a||1,this.x=(s[0]*t+s[4]*i+s[8]*r+s[12])/a,this.y=(s[1]*t+s[5]*i+s[9]*r+s[13])/a,this.z=(s[2]*t+s[6]*i+s[10]*r+s[14])/a,this}}]),e}(),T=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=t.fov,r=void 0===i?50:i,s=t.near,a=void 0===s?.1:s,n=t.far,o=void 0===n?150:n,l=t.width,u=t.height,d=t.pixelRatio,c=void 0===d?1:d;_classCallCheck(this,e),this.position=new w,this.projectionMatrix=new h,this._shouldUpdate=!1,this.setSize(),this.setPerspective(r,a,o,l,u,c)}return _createClass(e,[{key:"setFov",value:function(e){e=isNaN(e)?this.fov:parseFloat(e),(e=Math.max(1,Math.min(e,179)))!==this.fov&&(this.fov=e,this.setPosition(),this.setCSSPerspective(),this._shouldUpdate=!0)}},{key:"setNear",value:function(e){e=isNaN(e)?this.near:parseFloat(e),(e=Math.max(e,.01))!==this.near&&(this.near=e,this._shouldUpdate=!0)}},{key:"setFar",value:function(e){e=isNaN(e)?this.far:parseFloat(e),(e=Math.max(e,50))!==this.far&&(this.far=e,this._shouldUpdate=!0)}},{key:"setPixelRatio",value:function(e){e!==this.pixelRatio&&(this._shouldUpdate=!0),this.pixelRatio=e}},{key:"setSize",value:function(e,t){e===this.width&&t===this.height||(this._shouldUpdate=!0),this.width=e,this.height=t}},{key:"setPerspective",value:function(e,t,i,r,s,a){this.setPixelRatio(a),this.setSize(r,s),this.setFov(e),this.setNear(t),this.setFar(i),this._shouldUpdate&&this.updateProjectionMatrix()}},{key:"setPosition",value:function(){this.position.set(0,0,2*Math.tan(Math.PI/180*.5*this.fov))}},{key:"setCSSPerspective",value:function(){this.CSSPerspective=Math.pow(Math.pow(this.width/(2*this.pixelRatio),2)+Math.pow(this.height/(2*this.pixelRatio),2),.5)/Math.tan(this.fov/2*Math.PI/180)}},{key:"updateProjectionMatrix",value:function(){var e=this.width/this.height,t=this.near*Math.tan(Math.PI/180*.5*this.fov),i=2*t,r=e*i,s=-.5*r,a=s+r,n=t-i,h=2*this.near/(a-s),o=2*this.near/(t-n),l=(a+s)/(a-s),u=(t+n)/(t-n),d=-(this.far+this.near)/(this.far-this.near),c=-2*this.far*this.near/(this.far-this.near);this.projectionMatrix.setFromArray([h,0,0,0,0,o,0,0,l,u,d,-1,0,0,c,0])}},{key:"forceUpdate",value:function(){this._shouldUpdate=!0}},{key:"cancelUpdate",value:function(){this._shouldUpdate=!1}}]),e}(),S=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Float32Array([0,0,0,1]);_classCallCheck(this,e),this.type="Quat",this.elements=t}return _createClass(e,[{key:"setFromArray",value:function(e){this.elements[0]=e[0],this.elements[1]=e[1],this.elements[2]=e[2],this.elements[3]=e[3]}},{key:"setFromVec3",value:function(e,t){var i=.5*e.x,r=.5*e.y,s=.5*e.z,a=Math.sin(i),n=Math.cos(i),h=Math.sin(r),o=Math.cos(r),l=Math.sin(s),u=Math.cos(s);return t&&"XYZ"!==t||(this.elements[0]=a*o*u+n*h*l,this.elements[1]=n*h*u-a*o*l,this.elements[2]=n*o*l+a*h*u,this.elements[3]=n*o*u-a*h*l),this}}]),e}(),C=function(e){_inherits(r,e);var i=_createSuper(r);function r(e,t,s){var a,n=s.shareProgram,h=s.widthSegments,o=s.heightSegments,l=s.depthTest,u=s.cullFace,d=s.uniforms,c=s.vertexShaderID,p=s.fragmentShaderID,g=s.vertexShader,m=s.fragmentShader,f=s.texturesOptions,_=s.crossOrigin,v=s.alwaysDraw,x=void 0!==v&&v,y=s.visible,b=void 0===y||y,k=s.transparent,R=void 0!==k&&k,P=s.drawCheckMargins,w=void 0===P?{top:0,right:0,bottom:0,left:0}:P,S=s.autoloadSources,C=void 0===S||S,E=s.watchScroll,M=void 0===E||E,F=s.fov,A=void 0===F?50:F;return _classCallCheck(this,r),(a=i.call(this,e,t,"Plane",{shareProgram:n,widthSegments:h,heightSegments:o,depthTest:l,cullFace:u,uniforms:d,vertexShaderID:c,fragmentShaderID:p,vertexShader:g,fragmentShader:m,texturesOptions:f,crossOrigin:_})).index=a.renderer.planes.length,a.target=null,a.alwaysDraw=x,a._shouldDraw=!0,a.visible=b,a._transparent=R,a.drawCheckMargins=w,a.autoloadSources=C,a.watchScroll=M,a._updateMVMatrix=!1,a.camera=new T({fov:A,width:a.renderer._boundingRect.width,height:a.renderer._boundingRect.height,pixelRatio:a.renderer.pixelRatio}),a._program.compiled&&(a._initPlane(),a.renderer.scene.addPlane(_assertThisInitialized(a)),a.renderer.planes.push(_assertThisInitialized(a))),a}return _createClass(r,[{key:"_programRestored",value:function(){this.target&&this.setRenderTarget(this.renderer.renderTargets[this.target.index]),this._initMatrices(),this.setPerspective(this.camera.fov,this.camera.near,this.camera.far),this._applyWorldPositions(),this.renderer.scene.addPlane(this);for(var e=0;e<this.textures.length;e++)this.textures[e]._parent=this,this.textures[e]._restoreContext();this._canDraw=!0}},{key:"_initPlane",value:function(){this._initTransformValues(),this._initPositions(),this.setPerspective(this.camera.fov,this.camera.near,this.camera.far),this._initSources()}},{key:"_initTransformValues",value:function(){this.rotation=new w,this.quaternion=new S,this.relativeTranslation=new w,this._translation=new w,this.scale=new w(1,1,1),this.transformOrigin=new w(.5,.5,0)}},{key:"resetPlane",value:function(e){this._initTransformValues(),null!==e&&e?(this.htmlElement=e,this.updatePosition()):e||this.renderer.production||t(this.type+": You are trying to reset a plane with a HTML element that does not exist. The old HTML element will be kept instead.")}},{key:"_initPositions",value:function(){this._initMatrices(),this._applyWorldPositions()}},{key:"_initMatrices",value:function(){this._matrices={mvMatrix:{name:"uMVMatrix",matrix:new h,location:this.gl.getUniformLocation(this._program.program,"uMVMatrix")},pMatrix:{name:"uPMatrix",matrix:new h,location:this.gl.getUniformLocation(this._program.program,"uPMatrix")}}}},{key:"_setWorldSizes",value:function(){var e=this._boundingRect.document.width/2+this._boundingRect.document.left,t=this._boundingRect.document.height/2+this._boundingRect.document.top,i=this.renderer._boundingRect.width/2+this.renderer._boundingRect.left,r=this.renderer._boundingRect.height/2+this.renderer._boundingRect.top;this._boundingRect.world={width:this._boundingRect.document.width/this.renderer._boundingRect.width,height:this._boundingRect.document.height/this.renderer._boundingRect.height,top:(r-t)/this.renderer._boundingRect.height,left:(e-i)/this.renderer._boundingRect.height},this._boundingRect.world.scale={x:this.renderer._boundingRect.width/this.renderer._boundingRect.height*this._boundingRect.world.width/2,y:this._boundingRect.world.height/2}}},{key:"_setPerspectiveMatrix",value:function(){(this.shareProgram||!this.shareProgram&&this.camera._shouldUpdate)&&(this.renderer.useProgram(this._program),this.gl.uniformMatrix4fv(this._matrices.pMatrix.location,!1,this._matrices.pMatrix.matrix.elements)),this.camera.cancelUpdate()}},{key:"setPerspective",value:function(e,t,i){this.camera.setPerspective(e,t,i,this.renderer._boundingRect.width,this.renderer._boundingRect.height,this.renderer.pixelRatio),this.renderer.state.isContextLost&&this.camera.forceUpdate(),this._matrices.pMatrix.matrix=this.camera.projectionMatrix,this._updateMVMatrix=this.camera._shouldUpdate}},{key:"_setMVMatrix",value:function(){if(this._updateMVMatrix){this._translation.z=this.relativeTranslation.z/this.camera.CSSPerspective;var e=new w(this._translation.x,this._translation.y,-(1-this._translation.z)/this.camera.position.z),t={x:2*this.transformOrigin.x-1,y:-(2*this.transformOrigin.y-1)},i=new w(t.x*this._boundingRect.world.scale.x,t.y*this._boundingRect.world.scale.y,this.transformOrigin.z),r=(new h).composeFromOrigin(e,this.quaternion,this.scale,i),s=new h([this._boundingRect.world.scale.x,0,0,0,0,this._boundingRect.world.scale.y,0,0,0,0,1,0,0,0,0,1]);this._matrices.mvMatrix.matrix=r.multiply(s),this._matrices.mVPMatrix=this._matrices.pMatrix.matrix.multiply(this._matrices.mvMatrix.matrix),this.alwaysDraw||this._shouldDrawCheck()}(this.shareProgram||!this.shareProgram&&this._updateMVMatrix)&&(this.renderer.useProgram(this._program),this.gl.uniformMatrix4fv(this._matrices.mvMatrix.location,!1,this._matrices.mvMatrix.matrix.elements)),this._updateMVMatrix=!1}},{key:"setScale",value:function(e,t){if(e=isNaN(e)?this.scale.x:parseFloat(e),t=isNaN(t)?this.scale.y:parseFloat(t),e=Math.max(e,.001),t=Math.max(t,.001),e!==this.scale.x||t!==this.scale.y){this.scale.set(e,t,1);for(var i=0;i<this.textures.length;i++)this.textures[i].resize();this._updateMVMatrix=!0}}},{key:"setRotation",value:function(e,t,i){e=isNaN(e)?this.rotation.x:parseFloat(e),t=isNaN(t)?this.rotation.y:parseFloat(t),i=isNaN(i)?this.rotation.z:parseFloat(i),e===this.rotation.x&&t===this.rotation.y&&i===this.rotation.z||(this.rotation.set(e,t,i),this.quaternion.setFromVec3(this.rotation,"XYZ"),this._updateMVMatrix=!0)}},{key:"setTransformOrigin",value:function(e,t,i){e=isNaN(e)?this.transformOrigin.x:parseFloat(e),t=isNaN(t)?this.transformOrigin.y:parseFloat(t),i=isNaN(i)?this.transformOrigin.z:parseFloat(i),e===this.transformOrigin.x&&t===this.transformOrigin.y&&i===this.transformOrigin.z||(this.transformOrigin.set(e,t,i),this._updateMVMatrix=!0)}},{key:"_setTranslation",value:function(){var e=new w;0===this.relativeTranslation.x&&0===this.relativeTranslation.y&&0===this.relativeTranslation.z||(e=this._documentToWorldSpace(this.relativeTranslation)),this._translation.set(this._boundingRect.world.left+e.x,this._boundingRect.world.top+e.y,this._translation.z),this._updateMVMatrix=!0}},{key:"setRelativePosition",value:function(e,t,i){e=isNaN(e)?this.relativeTranslation.x:parseFloat(e),t=isNaN(t)?this.relativeTranslation.y:parseFloat(t),i=isNaN(i)?this.relativeTranslation.z:parseFloat(i),e===this.relativeTranslation.x&&t===this.relativeTranslation.y&&i===this.relativeTranslation.z||(this.relativeTranslation.set(e,t,i),this._setTranslation())}},{key:"_documentToWorldSpace",value:function(e){return new w(e.x/(this.renderer._boundingRect.width/this.renderer.pixelRatio)*(this.renderer._boundingRect.width/this.renderer._boundingRect.height),-e.y/(this.renderer._boundingRect.height/this.renderer.pixelRatio),e.z)}},{key:"_getIntersection",value:function(e,t){for(var i=t.clone().sub(e),r=e.clone();r.z>-1;)r.add(i);return r}},{key:"_getNearPlaneIntersections",value:function(e,t,i){if(1===i.length)0===i[0]?(t[0]=this._getIntersection(t[1],new w(.95,1,0).applyMat4(this._matrices.mVPMatrix)),t.push(this._getIntersection(t[3],new w(-1,-.95,0).applyMat4(this._matrices.mVPMatrix)))):1===i[0]?(t[1]=this._getIntersection(t[0],new w(-.95,1,0).applyMat4(this._matrices.mVPMatrix)),t.push(this._getIntersection(t[2],new w(1,-.95,0).applyMat4(this._matrices.mVPMatrix)))):2===i[0]?(t[2]=this._getIntersection(t[3],new w(-.95,-1,0).applyMat4(this._matrices.mVPMatrix)),t.push(this._getIntersection(t[1],new w(1,.95,0).applyMat4(this._matrices.mVPMatrix)))):3===i[0]&&(t[3]=this._getIntersection(t[2],new w(.95,-1,0).applyMat4(this._matrices.mVPMatrix)),t.push(this._getIntersection(t[0],new w(-1,.95,0).applyMat4(this._matrices.mVPMatrix))));else if(2===i.length)0===i[0]&&1===i[1]?(t[0]=this._getIntersection(t[3],new w(-1,-.95,0).applyMat4(this._matrices.mVPMatrix)),t[1]=this._getIntersection(t[2],new w(1,-.95,0).applyMat4(this._matrices.mVPMatrix))):1===i[0]&&2===i[1]?(t[1]=this._getIntersection(t[0],new w(-.95,1,0).applyMat4(this._matrices.mVPMatrix)),t[2]=this._getIntersection(t[3],new w(-.95,-1,0).applyMat4(this._matrices.mVPMatrix))):2===i[0]&&3===i[1]?(t[2]=this._getIntersection(t[1],new w(1,.95,0).applyMat4(this._matrices.mVPMatrix)),t[3]=this._getIntersection(t[0],new w(-1,.95,0).applyMat4(this._matrices.mVPMatrix))):0===i[0]&&3===i[1]&&(t[0]=this._getIntersection(t[1],new w(.95,1,0).applyMat4(this._matrices.mVPMatrix)),t[3]=this._getIntersection(t[2],new w(.95,-1,0).applyMat4(this._matrices.mVPMatrix)));else if(3===i.length){for(var r=0,s=0;s<e.length;s++)i.includes(s)||(r=s);t=[t[r]],0===r?(t.push(this._getIntersection(t[0],new w(-.95,1,0).applyMat4(this._matrices.mVPMatrix))),t.push(this._getIntersection(t[0],new w(-1,.95,0).applyMat4(this._matrices.mVPMatrix)))):1===r?(t.push(this._getIntersection(t[0],new w(.95,1,0).applyMat4(this._matrices.mVPMatrix))),t.push(this._getIntersection(t[0],new w(1,.95,0).applyMat4(this._matrices.mVPMatrix)))):2===r?(t.push(this._getIntersection(t[0],new w(.95,-1,0).applyMat4(this._matrices.mVPMatrix))),t.push(this._getIntersection(t[0],new w(1,-.95,0).applyMat4(this._matrices.mVPMatrix)))):3===r&&(t.push(this._getIntersection(t[0],new w(-.95,-1,0).applyMat4(this._matrices.mVPMatrix))),t.push(this._getIntersection(t[0],new w(-1.95,0).applyMat4(this._matrices.mVPMatrix))))}else for(var a=0;a<e.length;a++)t[a][0]=1e4,t[a][1]=1e4;return t}},{key:"_getWorldCoords",value:function(){for(var e=[new w(-1,1,0),new w(1,1,0),new w(1,-1,0),new w(-1,-1,0)],t=[],i=[],r=0;r<e.length;r++){var s=e[r].applyMat4(this._matrices.mVPMatrix);t.push(s),Math.abs(s.z)>1&&i.push(r)}i.length&&(t=this._getNearPlaneIntersections(e,t,i));for(var a=1/0,n=-1/0,h=1/0,o=-1/0,l=0;l<t.length;l++){var u=t[l];u.x<a&&(a=u.x),u.x>n&&(n=u.x),u.y<h&&(h=u.y),u.y>o&&(o=u.y)}return{top:o,right:n,bottom:h,left:a}}},{key:"_computeWebGLBoundingRect",value:function(){var e=this._getWorldCoords(),t={top:1-(e.top+1)/2,right:(e.right+1)/2,bottom:1-(e.bottom+1)/2,left:(e.left+1)/2};t.width=t.right-t.left,t.height=t.bottom-t.top,this._boundingRect.worldToDocument={width:t.width*this.renderer._boundingRect.width,height:t.height*this.renderer._boundingRect.height,top:t.top*this.renderer._boundingRect.height+this.renderer._boundingRect.top,left:t.left*this.renderer._boundingRect.width+this.renderer._boundingRect.left,right:t.left*this.renderer._boundingRect.width+this.renderer._boundingRect.left+t.width*this.renderer._boundingRect.width,bottom:t.top*this.renderer._boundingRect.height+this.renderer._boundingRect.top+t.height*this.renderer._boundingRect.height}}},{key:"getWebGLBoundingRect",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._matrices.mVPMatrix?(this._boundingRect.worldToDocument&&!e||this._computeWebGLBoundingRect(),this._boundingRect.worldToDocument):this._boundingRect.document}},{key:"_getWebGLDrawRect",value:function(){return this._computeWebGLBoundingRect(),{top:this._boundingRect.worldToDocument.top-this.drawCheckMargins.top,right:this._boundingRect.worldToDocument.right+this.drawCheckMargins.right,bottom:this._boundingRect.worldToDocument.bottom+this.drawCheckMargins.bottom,left:this._boundingRect.worldToDocument.left-this.drawCheckMargins.left}}},{key:"_shouldDrawCheck",value:function(){var e=this,t=this._getWebGLDrawRect();Math.round(t.right)<=this.renderer._boundingRect.left||Math.round(t.left)>=this.renderer._boundingRect.left+this.renderer._boundingRect.width||Math.round(t.bottom)<=this.renderer._boundingRect.top||Math.round(t.top)>=this.renderer._boundingRect.top+this.renderer._boundingRect.height?this._shouldDraw&&(this._shouldDraw=!1,this.renderer.nextRender.add((function(){return e._onLeaveViewCallback&&e._onLeaveViewCallback()}))):(this._shouldDraw||this.renderer.nextRender.add((function(){return e._onReEnterViewCallback&&e._onReEnterViewCallback()})),this._shouldDraw=!0)}},{key:"isDrawn",value:function(){return this._canDraw&&this.visible&&(this._shouldDraw||this.alwaysDraw)}},{key:"_applyWorldPositions",value:function(){this._setWorldSizes(),this._setTranslation()}},{key:"updatePosition",value:function(){this._setDocumentSizes(),this._applyWorldPositions()}},{key:"updateScrollPosition",value:function(e,t){(e||t)&&(this._boundingRect.document.top+=t*this.renderer.pixelRatio,this._boundingRect.document.left+=e*this.renderer.pixelRatio,this._applyWorldPositions())}},{key:"enableDepthTest",value:function(e){this._depthTest=e}},{key:"moveToFront",value:function(){this.enableDepthTest(!1),this.renderer.scene.movePlaneToFront(this)}},{key:"_initSources",value:function(){var e=0;if(this.autoloadSources){for(var t=[],i=0;i<this.htmlElement.getElementsByTagName("img").length;i++)t.push(this.htmlElement.getElementsByTagName("img")[i]);t.length>0&&this.loadImages(t);for(var r=[],s=0;s<this.htmlElement.getElementsByTagName("video").length;s++)r.push(this.htmlElement.getElementsByTagName("video")[s]);r.length>0&&this.loadVideos(r);for(var a=[],n=0;n<this.htmlElement.getElementsByTagName("canvas").length;n++)a.push(this.htmlElement.getElementsByTagName("canvas")[n]);a.length>0&&this.loadCanvases(a),e=t.length+r.length+a.length}this.loader._setLoaderSize(e),this._canDraw=!0}},{key:"_startDrawing",value:function(){this._canDraw&&(this._onRenderCallback&&this._onRenderCallback(),this.target?this.renderer.bindFrameBuffer(this.target):null===this.renderer.state.scenePassIndex&&this.renderer.bindFrameBuffer(null),this._setPerspectiveMatrix(),this._setMVMatrix(),(this.alwaysDraw||this._shouldDraw)&&this.visible&&this._draw())}},{key:"onReEnterView",value:function(e){return e&&(this._onReEnterViewCallback=e),this}},{key:"onLeaveView",value:function(e){return e&&(this._onLeaveViewCallback=e),this}}]),r}(R),E=function(){function e(){_classCallCheck(this,e),this.clear()}return _createClass(e,[{key:"clear",value:function(){this.queue=[]}},{key:"add",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r={callback:e,keep:i,timeout:null};return r.timeout=setTimeout((function(){t.queue.push(r)}),0),r}},{key:"execute",value:function(){var e=this;this.queue.map((function(t){t.callback&&t.callback(),clearTimeout(e.queue.timeout)})),this.queue=this.queue.filter((function(e){return e.keep}))}}]),e}(),M=function(){function e(i){var r=i.alpha,s=i.antialias,a=i.premultipliedAlpha,n=i.depth,h=i.failIfMajorPerformanceCaveat,o=i.preserveDrawingBuffer,l=i.stencil,u=i.container,d=i.pixelRatio,c=i.renderingScale,p=i.production,g=i.onError,m=i.onContextLost,f=i.onContextRestored,_=i.onDisposed,v=i.onSceneChange;_classCallCheck(this,e),this.type="Renderer",this.alpha=r,this.antialias=s,this.premultipliedAlpha=a,this.depth=n,this.failIfMajorPerformanceCaveat=h,this.preserveDrawingBuffer=o,this.stencil=l,this.container=u,this.pixelRatio=d,this._renderingScale=c,this.production=p,this.onError=g,this.onContextLost=m,this.onContextRestored=f,this.onDisposed=_,this.onSceneChange=v,this.initState(),this.canvas=document.createElement("canvas");var x={alpha:this.alpha,premultipliedAlpha:this.premultipliedAlpha,antialias:this.antialias,depth:this.depth,failIfMajorPerformanceCaveat:this.failIfMajorPerformanceCaveat,preserveDrawingBuffer:this.preserveDrawingBuffer,stencil:this.stencil};if(this.gl=this.canvas.getContext("webgl2",x),this._isWebGL2=!!this.gl,this.gl||(this.gl=this.canvas.getContext("webgl",x)||this.canvas.getContext("experimental-webgl",x)),!this.gl)return this.production||t(this.type+": WebGL context could not be created"),this.state.isActive=!1,void(this.onError&&this.onError());this.initRenderer()}return _createClass(e,[{key:"initState",value:function(){this.state={isActive:!0,isContextLost:!0,drawingEnabled:!0,forceRender:!1,currentProgramID:null,setDepth:null,cullFace:null,frameBufferID:null,scenePassIndex:null,activeTexture:null,unpackAlignment:null,flipY:null,premultiplyAlpha:null}}},{key:"CallbackQueueManager",value:function(){this.nextRender=new E}},{key:"initRenderer",value:function(){this.planes=[],this.renderTargets=[],this.shaderPasses=[],this.state.isContextLost=!1,this.CallbackQueueManager(),this.setBlendFunc(),this.setDepth(!0),this.cache=new n,this.scene=new a(this),this.getExtensions(),this._contextLostHandler=this.contextLost.bind(this),this.canvas.addEventListener("webglcontextlost",this._contextLostHandler,!1),this._contextRestoredHandler=this.contextRestored.bind(this),this.canvas.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1)}},{key:"getExtensions",value:function(){this.extensions=[],this._isWebGL2?(this.extensions.EXT_color_buffer_float=this.gl.getExtension("EXT_color_buffer_float"),this.extensions.OES_texture_float_linear=this.gl.getExtension("OES_texture_float_linear"),this.extensions.EXT_texture_filter_anisotropic=this.gl.getExtension("EXT_texture_filter_anisotropic"),this.extensions.WEBGL_lose_context=this.gl.getExtension("WEBGL_lose_context")):(this.extensions.OES_vertex_array_object=this.gl.getExtension("OES_vertex_array_object"),this.extensions.OES_texture_float=this.gl.getExtension("OES_texture_float"),this.extensions.OES_texture_float_linear=this.gl.getExtension("OES_texture_float_linear"),this.extensions.OES_texture_half_float=this.gl.getExtension("OES_texture_half_float"),this.extensions.OES_texture_half_float_linear=this.gl.getExtension("OES_texture_half_float_linear"),this.extensions.EXT_texture_filter_anisotropic=this.gl.getExtension("EXT_texture_filter_anisotropic"),this.extensions.OES_element_index_uint=this.gl.getExtension("OES_element_index_uint"),this.extensions.OES_standard_derivatives=this.gl.getExtension("OES_standard_derivatives"),this.extensions.EXT_sRGB=this.gl.getExtension("EXT_sRGB"),this.extensions.WEBGL_depth_texture=this.gl.getExtension("WEBGL_depth_texture"),this.extensions.WEBGL_draw_buffers=this.gl.getExtension("WEBGL_draw_buffers"),this.extensions.WEBGL_lose_context=this.gl.getExtension("WEBGL_lose_context"))}},{key:"contextLost",value:function(e){var t=this;this.state.isContextLost=!0,this.state.isActive&&(e.preventDefault(),this.nextRender.add((function(){return t.onContextLost&&t.onContextLost()})))}},{key:"restoreContext",value:function(){this.state.isActive&&(this.initState(),this.gl&&this.extensions.WEBGL_lose_context?this.extensions.WEBGL_lose_context.restoreContext():(this.gl||this.production?this.extensions.WEBGL_lose_context||this.production||t(this.type+": Could not restore the context because the restore context extension is not defined"):t(this.type+": Could not restore the context because the context is not defined"),this.onError&&this.onError()))}},{key:"isContextexFullyRestored",value:function(){for(var e=!0,t=0;t<this.renderTargets.length;t++){this.renderTargets[t].textures[0]._canDraw||(e=!1);break}if(e)for(var i=0;i<this.planes.length;i++){if(!this.planes[i]._canDraw){e=!1;break}for(var r=0;r<this.planes[i].textures.length;r++)if(!this.planes[i].textures[r]._canDraw){e=!1;break}}if(e)for(var s=0;s<this.shaderPasses.length;s++){if(!this.shaderPasses[s]._canDraw){e=!1;break}for(var a=0;a<this.shaderPasses[s].textures.length;a++)if(!this.shaderPasses[s].textures[a]._canDraw){e=!1;break}}return e}},{key:"contextRestored",value:function(){var e=this;this.getExtensions(),this.setBlendFunc(),this.setDepth(!0),this.cache.clear(),this.scene.initStacks();for(var t=0;t<this.renderTargets.length;t++)this.renderTargets[t]._restoreContext();for(var i=0;i<this.planes.length;i++)this.planes[i]._restoreContext();for(var r=0;r<this.shaderPasses.length;r++)this.shaderPasses[r]._restoreContext();var s=this.nextRender.add((function(){e.isContextexFullyRestored()&&(s.keep=!1,e.state.isContextLost=!1,e.onContextRestored&&e.onContextRestored(),e.onSceneChange(),e.needRender())}),!0)}},{key:"setPixelRatio",value:function(e){this.pixelRatio=e}},{key:"setSize",value:function(){if(this.gl){var e=this.container.getBoundingClientRect();this._boundingRect={width:e.width*this.pixelRatio,height:e.height*this.pixelRatio,top:e.top*this.pixelRatio,left:e.left*this.pixelRatio};var t=!!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/),i=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(t&&i){this._boundingRect.top=function(e){for(var t=0;e&&!isNaN(e.offsetTop);)t+=e.offsetTop-e.scrollTop,e=e.offsetParent;return t}(this.container)*this.pixelRatio}this.canvas.style.width=Math.floor(this._boundingRect.width/this.pixelRatio)+"px",this.canvas.style.height=Math.floor(this._boundingRect.height/this.pixelRatio)+"px",this.canvas.width=Math.floor(this._boundingRect.width*this._renderingScale),this.canvas.height=Math.floor(this._boundingRect.height*this._renderingScale),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}}},{key:"resize",value:function(){for(var e=0;e<this.planes.length;e++)this.planes[e]._canDraw&&this.planes[e].resize();for(var t=0;t<this.shaderPasses.length;t++)this.shaderPasses[t]._canDraw&&this.shaderPasses[t].resize();for(var i=0;i<this.renderTargets.length;i++)this.renderTargets[i].resize();this.needRender()}},{key:"clear",value:function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}},{key:"bindFrameBuffer",value:function(e,t){var i=null;e?(i=e.index)!==this.state.frameBufferID&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e._frameBuffer),this.gl.viewport(0,0,e._size.width,e._size.height),e._shouldClear&&!t&&this.clear()):null!==this.state.frameBufferID&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)),this.state.frameBufferID=i}},{key:"setDepth",value:function(e){e&&!this.state.depthTest?(this.state.depthTest=e,this.gl.enable(this.gl.DEPTH_TEST)):!e&&this.state.depthTest&&(this.state.depthTest=e,this.gl.disable(this.gl.DEPTH_TEST))}},{key:"setBlendFunc",value:function(){this.gl.enable(this.gl.BLEND),this.premultipliedAlpha?this.gl.blendFuncSeparate(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA):this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA)}},{key:"setFaceCulling",value:function(e){if(this.state.cullFace!==e)if(this.state.cullFace=e,"none"===e)this.gl.disable(this.gl.CULL_FACE);else{var t="front"===e?this.gl.FRONT:this.gl.BACK;this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(t)}}},{key:"useProgram",value:function(e){null!==this.state.currentProgramID&&this.state.currentProgramID===e.id||(this.gl.useProgram(e.program),this.state.currentProgramID=e.id)}},{key:"addPlane",value:function(e,i){if(this.gl){if(!e||0===e.length)return this.production||t(this.type+": The HTML element you specified does not currently exists in the DOM"),!1;var r=new C(this,e,i);return r._program.compiled||(r=!1),r}return this.production||t(this.type+": Unable to create a Plane because the WebGl context is not defined"),!1}},{key:"removePlane",value:function(e){this.gl&&(this.planes=this.planes.filter((function(t){return t.uuid!==e.uuid})),this.scene.removePlane(e),e=null,this.gl&&this.clear(),this.onSceneChange())}},{key:"addRenderTarget",value:function(e){return this.gl?new u(this,e):(this.production||t(this.type+": Unable to create a RenderTarget because the WebGl context is not defined"),!1)}},{key:"removeRenderTarget",value:function(e){if(this.gl){for(var t=0;t<this.planes.length;t++)this.planes[t].target&&this.planes[t].target.uuid===e.uuid&&(this.planes[t].target=null);this.renderTargets=this.renderTargets.filter((function(t){return t.uuid!==e.uuid})),e=null,this.gl&&this.clear(),this.onSceneChange()}}},{key:"addShaderPass",value:function(e){if(this.gl){var i=new P(this,e);return i._program.compiled||(i=!1),i}return this.production||t(this.type+": Unable to create a ShaderPass because the WebGl context is not defined"),!1}},{key:"removeShaderPass",value:function(e){this.gl&&(this.shaderPasses=this.shaderPasses.filter((function(t){return t.uuid!==e.uuid})),this.scene.removeShaderPass(e),e=null,this.gl&&this.clear(),this.onSceneChange())}},{key:"enableDrawing",value:function(){this.state.drawingEnabled=!0}},{key:"disableDrawing",value:function(){this.state.drawingEnabled=!1}},{key:"needRender",value:function(){this.state.forceRender=!0}},{key:"render",value:function(){this.gl&&(this.clear(),this.scene.draw())}},{key:"deletePrograms",value:function(){for(var e=0;e<this.cache.programs.length;e++){var t=this.cache.programs[e];this.gl.deleteProgram(t.program)}}},{key:"dispose",value:function(){var e=this;if(this.gl){for(this.state.isActive=!1;this.planes.length>0;)this.removePlane(this.planes[0]);for(;this.shaderPasses.length>0;)this.removeShaderPass(this.shaderPasses[0]);for(;this.renderTargets.length>0;)this.removeRenderTarget(this.renderTargets[0]);var t=this.nextRender.add((function(){0===e.planes.length&&0===e.shaderPasses.length&&0===e.renderTargets.length&&(t.keep=!1,e.deletePrograms(),e.clear(),e.canvas.removeEventListener("webgllost",e._contextLostHandler,!1),e.canvas.removeEventListener("webglrestored",e._contextRestoredHandler,!1),e.gl&&e.extensions.WEBGL_lose_context&&e.extensions.WEBGL_lose_context.loseContext(),e.canvas.width=e.canvas.width,e.gl=null,e.container.removeChild(e.canvas),e.container=null,e.canvas=null,e.onDisposed&&e.onDisposed())}),!0)}}}]),e}(),F=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=t.xOffset,r=void 0===i?0:i,s=t.yOffset,a=void 0===s?0:s,n=t.lastXDelta,h=void 0===n?0:n,o=t.lastYDelta,l=void 0===o?0:o,u=t.shouldWatch,d=void 0===u||u,c=t.onScroll,p=void 0===c?function(){}:c;_classCallCheck(this,e),this.xOffset=r,this.yOffset=a,this.lastXDelta=h,this.lastYDelta=l,this.shouldWatch=d,this.onScroll=p,this.handler=this.scroll.bind(this,!0),this.shouldWatch&&window.addEventListener("scroll",this.handler,{passive:!0})}return _createClass(e,[{key:"scroll",value:function(){this.updateScrollValues(window.pageXOffset,window.pageYOffset)}},{key:"updateScrollValues",value:function(e,t){var i=this.xOffset;this.xOffset=e,this.lastXDelta=i-this.xOffset;var r=this.yOffset;this.yOffset=t,this.lastYDelta=r-this.yOffset,this.onScroll&&this.onScroll(this.lastXDelta,this.lastYDelta)}},{key:"dispose",value:function(){this.shouldWatch&&window.removeEventListener("scroll",this.handler,{passive:!0})}}]),e}(),A=function(){function e(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=i.container,s=i.alpha,a=void 0===s||s,n=i.premultipliedAlpha,h=void 0!==n&&n,o=i.antialias,l=void 0===o||o,u=i.depth,d=void 0===u||u,c=i.failIfMajorPerformanceCaveat,p=void 0===c||c,g=i.preserveDrawingBuffer,m=void 0!==g&&g,f=i.stencil,_=void 0!==f&&f,v=i.autoResize,x=void 0===v||v,y=i.autoRender,b=void 0===y||y,k=i.watchScroll,R=void 0===k||k,P=i.pixelRatio,w=void 0===P?window.devicePixelRatio||1:P,T=i.renderingScale,S=void 0===T?1:T,C=i.production,E=void 0!==C&&C;_classCallCheck(this,e),this.type="Curtains",this._autoResize=x,this._autoRender=b,this._watchScroll=R,this.pixelRatio=w,S=isNaN(S)?1:parseFloat(S),this._renderingScale=Math.max(.25,Math.min(1,S)),this.premultipliedAlpha=h,this.alpha=a,this.antialias=l,this.depth=d,this.failIfMajorPerformanceCaveat=p,this.preserveDrawingBuffer=m,this.stencil=_,this.production=E,this.errors=!1,r?this.setContainer(r):this.production||t(this.type+": no container provided in the initial parameters. Use setContainer() method to set one later and initialize the WebGL context")}return _createClass(e,[{key:"setContainer",value:function(e){if(e)if("string"==typeof e)if(e=document.getElementById(e))this.container=e;else{var i=document.createElement("div");i.setAttribute("id","curtains-canvas"),document.body.appendChild(i),this.container=i,this.production||t('Curtains: no valid container HTML element or ID provided, created a div with "curtains-canvas" ID instead')}else e instanceof Element&&(this.container=e);else{var r=document.createElement("div");r.setAttribute("id","curtains-canvas"),document.body.appendChild(r),this.container=r,this.production||t('Curtains: no valid container HTML element or ID provided, created a div with "curtains-canvas" ID instead')}this._initCurtains()}},{key:"_initCurtains",value:function(){this.planes=[],this.renderTargets=[],this.shaderPasses=[],this._initRenderer(),this.gl&&(this._initScroll(),this._setSize(),this._addListeners(),this.container.appendChild(this.canvas),console.log("curtains.js - v7.0"),this._animationFrameID=null,this._autoRender&&this._animate())}},{key:"_initRenderer",value:function(){var e=this;this.renderer=new M({alpha:this.alpha,antialias:this.antialias,premulitpliedAlpha:this.premultipliedAlpha,depth:this.depth,failIfMajorPerformanceCaveat:this.failIfMajorPerformanceCaveat,preserveDrawingBuffer:this.preserveDrawingBuffer,stencil:this.stencil,container:this.container,pixelRatio:this.pixelRatio,renderingScale:this._renderingScale,production:this.production,onError:function(){return e._onRendererError()},onContextLost:function(){return e._onRendererContextLost()},onContextRestored:function(){return e._onRendererContextRestored()},onDisposed:function(){return e._onRendererDisposed()},onSceneChange:function(){return e._keepSync()}}),this.gl=this.renderer.gl,this.canvas=this.renderer.canvas}},{key:"restoreContext",value:function(){this.renderer.restoreContext()}},{key:"_animate",value:function(){this.render(),this._animationFrameID=window.requestAnimationFrame(this._animate.bind(this))}},{key:"enableDrawing",value:function(){this.renderer.enableDrawing()}},{key:"disableDrawing",value:function(){this.renderer.disableDrawing()}},{key:"needRender",value:function(){this.renderer.needRender()}},{key:"nextRender",value:function(e){this.renderer.nextRender.add(e)}},{key:"render",value:function(){this.renderer.nextRender.execute(),(this.renderer.state.drawingEnabled||this.renderer.state.forceRender)&&(this.renderer.state.forceRender&&(this.renderer.state.forceRender=!1),this._onRenderCallback&&this._onRenderCallback(),this.renderer.render())}},{key:"_addListeners",value:function(){this._resizeHandler=null,this._autoResize&&(this._resizeHandler=this.resize.bind(this,!0),window.addEventListener("resize",this._resizeHandler,!1))}},{key:"setPixelRatio",value:function(e,t){this.pixelRatio=parseFloat(Math.max(e,1))||1,this.renderer.setPixelRatio(e),this.resize(t)}},{key:"_setSize",value:function(){this.renderer.setSize(),this._scrollManager.shouldWatch&&(this._scrollManager.xOffset=window.pageXOffset,this._scrollManager.yOffset=window.pageYOffset)}},{key:"getBoundingRect",value:function(){return this.renderer._boundingRect}},{key:"resize",value:function(e){var t=this;this.gl&&(this._setSize(),this.renderer.resize(),this.nextRender((function(){t._onAfterResizeCallback&&e&&t._onAfterResizeCallback()})))}},{key:"_initScroll",value:function(){var e=this;this._scrollManager=new F({xOffset:window.pageXOffset,yOffset:window.pageYOffset,lastXDelta:0,lastYDelta:0,shouldWatch:this._watchScroll,onScroll:function(t,i){return e._updateScroll(t,i)}})}},{key:"_updateScroll",value:function(e,t){for(var i=0;i<this.planes.length;i++)this.planes[i].watchScroll&&this.planes[i].updateScrollPosition(e,t);this.renderer.needRender(),this._onScrollCallback&&this._onScrollCallback()}},{key:"updateScrollValues",value:function(e,t){this._scrollManager.updateScrollValues(e,t)}},{key:"getScrollDeltas",value:function(){return{x:this._scrollManager.lastXDelta,y:this._scrollManager.lastYDelta}}},{key:"getScrollValues",value:function(){return{x:this._scrollManager.xOffset,y:this._scrollManager.yOffset}}},{key:"_keepSync",value:function(){this.planes=this.renderer.planes,this.shaderPasses=this.renderer.shaderPasses,this.renderTargets=this.renderer.renderTargets}},{key:"addPlane",value:function(e,i){return t("Curtains: addPlane() is deprecated. To create a plane, use new Plane() with the following arguments:\ncurtains:",this,"\nhtmlElement:",e,"\nparameters:",i),this.renderer.addPlane(e,i)}},{key:"removePlane",value:function(e){t("Curtains: removePlane() is deprecated. To remove this plane ",e,", use the remove() method"),this.renderer.removePlane(e)}},{key:"addRenderTarget",value:function(e){return t("Curtains: addRenderTarget() is deprecated. To create a render target, use new RenderTarget() with the following arguments:\ncurtains:",this,"\nparameters:",e),this.renderer.addRenderTarget(e)}},{key:"removeRenderTarget",value:function(e){t("Curtains: removeRenderTarget() is deprecated. To remove this render target ",e,", use the remove() method"),this.renderer.removeRenderTarget(e)}},{key:"addShaderPass",value:function(e){return t("Curtains: addShaderPass() is deprecated. To create a shader pass, use new ShaderPass() with the following arguments:\ncurtains:",this,"\nparameters:",e),this.renderer.addShaderPass(e)}},{key:"removeShaderPass",value:function(e){t("Curtains: removeShaderPass() is deprecated. To remove this shader pass ",e,", use the remove() method"),this.renderer.removeShaderPass(e)}},{key:"lerp",value:function(e,t,i){return function(e,t,i){return(1-i)*e+i*t}(e,t,i)}},{key:"onAfterResize",value:function(e){return e&&(this._onAfterResizeCallback=e),this}},{key:"onError",value:function(e){return e&&(this._onErrorCallback=e),this}},{key:"_onRendererError",value:function(){var e=this;setTimeout((function(){e._onErrorCallback&&!e.errors&&e._onErrorCallback(),e.errors=!0}),0)}},{key:"onContextLost",value:function(e){return e&&(this._onContextLostCallback=e),this}},{key:"_onRendererContextLost",value:function(){this._onContextLostCallback&&this._onContextLostCallback()}},{key:"onContextRestored",value:function(e){return e&&(this._onContextRestoredCallback=e),this}},{key:"_onRendererContextRestored",value:function(){this._onContextRestoredCallback&&this._onContextRestoredCallback()}},{key:"onRender",value:function(e){return e&&(this._onRenderCallback=e),this}},{key:"onScroll",value:function(e){return e&&(this._onScrollCallback=e),this}},{key:"dispose",value:function(){this.renderer.dispose()}},{key:"_onRendererDisposed",value:function(){this._animationFrameID&&window.cancelAnimationFrame(this._animationFrameID),this._resizeHandler&&window.removeEventListener("resize",this._resizeHandler,!1),this._scrollManager&&this._scrollManager.dispose()}}]),e}(),D=function(e){_inherits(i,e);var t=_createSuper(i);function i(e,r){var s,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=a.sampler,h=void 0===n?"uPingPongTexture":n,o=a.shareProgram,l=a.widthSegments,d=a.heightSegments,c=a.depthTest,p=a.cullFace,g=a.uniforms,m=a.vertexShaderID,f=a.fragmentShaderID,_=a.vertexShader,v=a.fragmentShader,x=a.texturesOptions,y=a.crossOrigin,b=a.alwaysDraw,k=a.visible,R=a.transparent,P=a.drawCheckMargins,w=a.autoloadSources,T=a.watchScroll,S=a.fov;return _classCallCheck(this,i),c=!1,w=!1,(s=t.call(this,e,r,{shareProgram:o,widthSegments:l,heightSegments:d,depthTest:c,cullFace:p,uniforms:g,vertexShaderID:m,fragmentShaderID:f,vertexShader:_,fragmentShader:v,texturesOptions:x,crossOrigin:y,alwaysDraw:b,visible:k,transparent:R,drawCheckMargins:P,autoloadSources:w,watchScroll:T,fov:S})).readPass=new u(e,{depth:!1,clear:!1,texturesOptions:x}),s.writePass=new u(e,{depth:!1,clear:!1,texturesOptions:x}),s.createTexture({sampler:h,fromTexture:s.readPass.textures[0]}),s._onRenderCallback=function(){s.writePass&&s.setRenderTarget(s.writePass),s._onPingPongRenderCallback&&s._onPingPongRenderCallback()},s._onAfterRenderCallback=function(){s.readPass&&s.writePass&&s.textures[0]&&s.swapPasses(),s._onPingPongAfterRenderCallback&&s._onPingPongAfterRenderCallback()},s}return _createClass(i,[{key:"swapPasses",value:function(){var e=this.readPass;this.readPass=this.writePass,this.writePass=e,this.textures[0].copy(this.readPass.textures[0])}},{key:"getTexture",value:function(){return this.textures[0]}},{key:"onRender",value:function(e){return e&&(this._onPingPongRenderCallback=e),this}},{key:"onAfterRender",value:function(e){return e&&(this._onPingPongAfterRenderCallback=e),this}}]),i}(C);e.Curtains=A,e.FXAAPass=function e(t){var i=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=(r.shareProgram,r.widthSegments,r.heightSegments,r.depthTest),a=(r.cullFace,r.crossOrigin),n=r.depth,h=r.clear,o=r.renderTarget;_classCallCheck(this,e);var l="\n            precision mediump float;\n            \n            varying vec3 vVertexPosition;\n            varying vec2 vTextureCoord;\n        \n            uniform sampler2D uRenderTexture;\n            \n            uniform vec2 uResolution;\n            \n            #define FXAA_REDUCE_MIN   (1.0/128.0)\n            #define FXAA_REDUCE_MUL   (1.0/8.0)\n            #define FXAA_SPAN_MAX     8.0\n            \n            void main() {\n                vec2 res = 1.0 / uResolution;\n            \n                vec3 rgbNW = texture2D(uRenderTexture, (vTextureCoord.xy + vec2(-1.0, -1.0) * res)).xyz;\n                vec3 rgbNE = texture2D(uRenderTexture, (vTextureCoord.xy + vec2(1.0, -1.0) * res)).xyz;\n                vec3 rgbSW = texture2D(uRenderTexture, (vTextureCoord.xy + vec2(-1.0, 1.0) * res)).xyz;\n                vec3 rgbSE = texture2D(uRenderTexture, (vTextureCoord.xy + vec2(1.0, 1.0) * res)).xyz;\n                vec4 rgbaM = texture2D(uRenderTexture, vTextureCoord.xy * res);\n                vec3 rgbM = rgbaM.xyz;\n                vec3 luma = vec3(0.299, 0.587, 0.114);\n            \n                float lumaNW = dot(rgbNW, luma);\n                float lumaNE = dot(rgbNE, luma);\n                float lumaSW = dot(rgbSW, luma);\n                float lumaSE = dot(rgbSE, luma);\n                float lumaM  = dot(rgbM,  luma);\n                float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n                float lumaMax = max(lumaM, max(max(lumaNW, lumaNE) , max(lumaSW, lumaSE)));\n            \n                vec2 dir;\n                dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n                dir.y = ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n            \n                float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n            \n                float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n                dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n                      max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n                            dir * rcpDirMin)) * res;\n                vec4 rgbA = (1.0/2.0) * (\n                texture2D(uRenderTexture, vTextureCoord.xy + dir * (1.0/3.0 - 0.5)) +\n                texture2D(uRenderTexture, vTextureCoord.xy + dir * (2.0/3.0 - 0.5)));\n                vec4 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (\n                texture2D(uRenderTexture, vTextureCoord.xy + dir * (0.0/3.0 - 0.5)) +\n                texture2D(uRenderTexture, vTextureCoord.xy + dir * (3.0/3.0 - 0.5)));\n                float lumaB = dot(rgbB, vec4(luma, 0.0));\n            \n                if ((lumaB < lumaMin) || (lumaB > lumaMax)) {\n                    gl_FragColor = rgbA;\n                } else {\n                    gl_FragColor = rgbB;\n                }\n            }\n        ",u=t.renderer||t,d={resolution:{name:"uResolution",type:"2f",value:[u._boundingRect.width,u._boundingRect.height]}};this.pass=new P(t,{depthTest:s,fragmentShader:l,uniforms:d,crossOrigin:a,depth:n,clear:h,renderTarget:o}),this.pass.onAfterResize((function(){i.pass.uniforms.resolution.value=[i.pass.renderer._boundingRect.width,i.pass.renderer._boundingRect.height]}))},e.Mat4=h,e.PingPongPlane=D,e.Plane=C,e.RenderTarget=u,e.ShaderPass=P,e.Texture=l,e.TextureLoader=g,e.Vec2=o,e.Vec3=w,Object.defineProperty(e,"__esModule",{value:!0})}));
